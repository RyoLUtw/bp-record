<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BP Tracker</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --card2:#0f1621;
      --text:#e9eef6;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --accent:#8ab4ff;
      --good:rgba(80, 200, 120, .16);
      --s1:rgba(255, 196, 61, .18);
      --s2:rgba(255, 120, 80, .18);
      --s3:rgba(255, 70, 70, .18);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --text-scale: 1;
      --button-scale: 1;
      --scale-slider-margin-top: 12px;
      --scale-slider-margin-bottom: 12px;
      --vitals-slider-height: 36px;
      --adjust-btn-width: 72px;
      --adjust-btn-height: 48px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, rgba(138,180,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(255,120,80,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{max-width:980px; margin:0 auto; padding:18px 16px 40px;}

    header{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:12px; margin:10px 0 16px;
    }
    header h1{font-size:18px; margin:0; letter-spacing:.2px;}
    header .sub{font-size:12px; color:var(--muted); margin:0;}

    .topbar{
      position:sticky; top:0; z-index:5;
      padding:10px 0 14px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,20,.90), rgba(11,15,20,.55));
    }

    .langSwitch{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }

    .scaleBtn{
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
    }
    .langGroup{
      display:inline-flex;
      gap:4px;
      padding:4px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }
    .langBtn{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:6px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      font-size:12px;
    }
    .langBtn.active{
      background: rgba(138,180,255,.22);
      color: var(--text);
    }

    .addMeasureBtn{
      width:36px;
      height:36px;
      border-radius:12px;
      font-size:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }

    .stack{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* Slide switch tabs */
    .tabs{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 999px;
      padding:4px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:4px;
      box-shadow: var(--shadow);
    }
    .tabbtn{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
    }
    .tabbtn.active{
      background: rgba(138,180,255,.22);
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
      margin-top:14px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .card .hd h2{font-size:14px; margin:0;}
    .card .hd .hint{font-size:12px; color:var(--muted); margin:2px 0 0;}
    .card .bd{padding:14px;}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .row + .row{margin-top:12px}

    label{font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--text);
    }

    .field{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:10px;
      flex:1;
      min-width: 240px;
    }

    .field .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .valbox{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .numControl{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .adjustBtn{
      width:var(--adjust-btn-width);
      height:var(--adjust-btn-height);
      border-radius:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      line-height:1;
      padding:0;
    }

    input[type=number]{
      width:84px;
      height: var(--adjust-btn-height);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:0 8px;
      margin:6px;
      font-weight:700;
      outline:none;
      text-align:center;
      font-size: 2vh;
    }

    input[type=range]{
      width: 100%;
      height: var(--vitals-slider-height);
    }

    input[type=date]::-webkit-calendar-picker-indicator{
      filter: invert(1);
    }

    .triple{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap:10px;
    }
    @media (max-width: 560px){
      .triple{grid-template-columns:1fr}
      input[type=number]{width:100%}
      .field{min-width: 0}
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(138,180,255,.14);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.secondary{background: rgba(255,255,255,.06)}
    .btn.danger{background: rgba(255,70,70,.14)}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      min-width: 260px;
    }
    .switch{
      width:44px; height:24px; border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid var(--line);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      width:18px; height:18px; border-radius:999px;
      position:absolute; top:50%; left:3px;
      transform:translateY(-50%);
      background: rgba(255,255,255,.75);
      transition: all .18s ease;
    }
    .switch.on{background: rgba(80, 200, 120, .22)}
    .switch.on::after{left:22px; background: rgba(255,255,255,.92)}

    .timer{
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
      padding:12px;
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .timer strong{font-size:16px}
    .timer .mini{font-size:12px; color:var(--muted)}

    .chartWrap{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:10px;
      overflow:hidden;
    }
    canvas{width:100%; height:280px; display:block}
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:12px}
    .swatch{display:inline-flex; align-items:center; gap:6px}
    .sq{width:10px; height:10px; border-radius:3px; background:rgba(255,255,255,.25); border:1px solid rgba(255,255,255,.25)}

    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .rangeTableWrap{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      overflow:auto;
      background: rgba(0,0,0,.12);
    }
    .rangeTable{
      width:100%;
      border-collapse:collapse;
      min-width:680px;
      font-size:12px;
    }
    .rangeTable th, .rangeTable td{
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      text-align:left;
      white-space:nowrap;
    }
    .rangeTable th{
      color:var(--muted);
      font-weight:700;
      background: rgba(255,255,255,.04);
      position:sticky;
      top:0;
      z-index:1;
    }
    .rangeTable tbody tr:last-child td{border-bottom:0}
    .rangeTable td.center{text-align:center}
    .vitalsSlider.hidden{display:none}
    .item{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: var(--radius2);
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .item .a{display:flex; flex-direction:column; gap:4px}
    .item .b{text-align:right; color:var(--muted); font-size:12px}
    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1;}

    .flash{
      animation: flashPulse 0.6s ease-in-out 3;
    }

    @keyframes flashPulse{
      0%{background: rgba(138,180,255,.08);}
      50%{background: rgba(138,180,255,.28);}
      100%{background: rgba(138,180,255,.08);}
    }

    .sep{height:1px; background: var(--line); margin:12px 0}

    .notice{
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }
    .notice code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:11px;}

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }

    select, input[type=date]{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding:10px 10px;
      font-weight:600;
      outline:none;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:11px;
      color:var(--muted);
      gap:6px;
    }

    .rightStrip{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .footerRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }

    .smallBtn{
      font-size:12px;
      padding:8px 10px;
      border-radius: 12px;
    }

    .driveRow{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      justify-content:space-between;
    }

    .driveStatus{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:11px;
      color:var(--muted);
      background: rgba(0,0,0,.18);
    }

    .btn.google{
      background: rgba(255,255,255,.08);
    }

    .hidden{display:none !important}

    .editDialog{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(17,24,36,.95), rgba(15,22,33,.95));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .editGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .editGrid .full{grid-column:1 / -1}
    .editField{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .editActions{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    .scaleModal{
      position:fixed;
      inset:0;
      z-index:20;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.6);
      padding:16px;
    }
    .scaleDialog{
      width:min(460px, 100%);
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(17,24,36,.95), rgba(15,22,33,.95));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .scaleRow{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top: var(--scale-slider-margin-top);
      margin-bottom: var(--scale-slider-margin-bottom);
    }
    .scaleRow .meta{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
    }

    .prepDialog{
      width:min(760px, 100%);
      max-height:90vh;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(17,24,36,.95), rgba(15,22,33,.95));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .prepInstructions{
      margin:10px 0 14px;
      padding-left:20px;
      color:var(--text);
      font-size:14px;
      line-height:1.5;
    }
    .prepInstructions li + li{margin-top:8px;}
    .prepVideoWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#000;
    }
    .prepVideoWrap iframe{
      width:100%;
      aspect-ratio:16/9;
      display:block;
      border:0;
    }

  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="langSwitch">
        <button class="btn secondary scaleBtn" id="btnScale" type="button" data-i18n="actions.scale">UI setting</button>
        <div class="langGroup" role="group" aria-label="Language">
          <button class="langBtn" type="button" data-lang="en">English</button>
          <button class="langBtn" type="button" data-lang="zh">ç¹é«”ä¸­æ–‡</button>
        </div>
      </div>
      <header>
        <div>
          <h1 data-i18n="app.title">BP Tracker</h1>
          <p class="sub" data-i18n="app.subtitle">Two readings âœ auto-average âœ review by day / 7 days / 4 weeks</p>
        </div>
        <div class="pill mono" id="todayPill"></div>
      </header>

      <div class="tabs" role="tablist" aria-label="Tabs">
        <button class="tabbtn active" id="tabInput" role="tab" aria-selected="true" data-i18n="tabs.input">Input</button>
        <button class="tabbtn" id="tabReview" role="tab" aria-selected="false" data-i18n="tabs.review">Review</button>
      </div>
    </div>

    <div class="scaleModal hidden" id="scaleModal" role="dialog" aria-modal="true" aria-labelledby="scaleTitle">
      <div class="scaleDialog">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <strong id="scaleTitle" data-i18n="scale.title">UI setting</strong>
          <button class="btn secondary smallBtn" id="btnScaleClose" type="button" data-i18n="actions.close">Close</button>
        </div>
        <div class="scaleRow">
          <div class="meta">
            <span data-i18n="scale.text">Text size</span>
            <span class="mono" id="scaleTextLevel">3/6</span>
          </div>
          <input type="range" id="scaleTextSlider" min="1" max="6" step="1" value="3" />
        </div>
        <div class="scaleRow">
          <div class="meta">
            <span data-i18n="scale.buttons">Button size</span>
            <span class="mono" id="scaleButtonLevel">3/6</span>
          </div>
          <input type="range" id="scaleButtonSlider" min="1" max="6" step="1" value="3" />
        </div>
        <label class="notice" style="display:flex; align-items:center; gap:6px; margin-top:8px;">
          <input type="checkbox" id="showInputSliders" />
          <span data-i18n="scale.showInputSliders">Show SP/DP/HR sliders in input</span>
        </label>
      </div>
    </div>

    <div class="scaleModal hidden" id="prepModal" role="dialog" aria-modal="true" aria-labelledby="prepTitle">
      <div class="prepDialog">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <strong id="prepTitle" data-i18n="prep.title">Before your measurement</strong>
          <button class="btn secondary smallBtn" id="btnPrepClose" type="button" data-i18n-aria="actions.close">âœ•</button>
        </div>
        <ol class="prepInstructions">
          <li data-i18n="prep.step1">Sit comfortably in a chair with back supported (not perched on the edge).</li>
          <li data-i18n="prep.step2">Feet flat on the floor, legs uncrossed.</li>
          <li data-i18n="prep.step3">Rest your arm on a table/armrest so the cuff is at heart level.</li>
          <li data-i18n="prep.step4">Relax your shoulders, jaw, and hands (donâ€™t clench a fist).</li>
          <li data-i18n="prep.step5">Stay still and quietâ€”no talking, no phone scrolling, no reading something stressful, no walking around.</li>
        </ol>
        <div class="prepVideoWrap">
          <iframe width="560" height="315" src="https://www.youtube.com/embed/n5mkXSARqX0?si=hI42wg4Ts323fRu9" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
      </div>
    </div>


    <div class="scaleModal hidden" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="editDialog">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <strong id="editTitle" data-i18n="edit.title">Edit measurement</strong>
          <button class="btn secondary smallBtn" id="btnEditCancelTop" type="button" data-i18n="actions.cancel">Cancel</button>
        </div>

        <div class="editGrid">
          <div class="editField">
            <label for="editDate" data-i18n="labels.date">Date</label>
            <input type="date" id="editDate" />
          </div>
          <div class="editField">
            <label for="editTime" data-i18n="labels.time">Time</label>
            <input type="time" id="editTime" />
          </div>
          <div class="editField">
            <label for="editSlot" data-i18n="review.modeLabel">Mode</label>
            <select id="editSlot">
              <option value="morning" data-i18n="timeSlot.morning">Morning</option>
              <option value="midday" data-i18n="time.midday">Midday</option>
              <option value="evening" data-i18n="timeSlot.evening">Evening</option>
              <option value="night" data-i18n="time.night">Night</option>
              <option value="other" data-i18n="time.other">Other</option>
            </select>
          </div>
          <label class="editField" style="justify-content:flex-end;">
            <span data-i18n="medication.title">Medication taken today</span>
            <input type="checkbox" id="editMedTaken" />
          </label>

          <div class="editField">
            <label for="editSp" data-i18n="labels.systolic">Systolic (SP)</label>
            <input class="mono" type="number" id="editSp" min="60" max="200" step="1" />
          </div>
          <div class="editField">
            <label for="editDp" data-i18n="labels.diastolic">Diastolic (DP)</label>
            <input class="mono" type="number" id="editDp" min="40" max="160" step="1" />
          </div>
          <div class="editField full">
            <label for="editHr" data-i18n="labels.heartRate">Heart rate</label>
            <input class="mono" type="number" id="editHr" min="60" max="130" step="1" />
          </div>
        </div>

        <div class="editActions">
          <button class="btn secondary" id="btnEditCancel" type="button" data-i18n="actions.cancel">Cancel</button>
          <button class="btn" id="btnEditConfirm" type="button" data-i18n="actions.confirmChange">Confirm change</button>
        </div>
      </div>
    </div>

    <!-- INPUT VIEW -->
    <section id="viewInput">
      <div class="grid">

        <div class="card">
          <div class="hd">
            <div>
              <h2 data-i18n="input.title">Measurement input</h2>
              <div class="hint" data-i18n="input.hint">Defaults to last 7-day averages (or 120/80 HR 80)</div>
            </div>
            <div class="rightStrip">
              <button
                class="btn secondary addMeasureBtn"
                id="btnAddMeasurement"
                type="button"
                aria-label="Add measurement"
                data-i18n-aria="actions.addMeasurement"
                title="+"
              >
                +
              </button>
            </div>
          </div>
          <div class="bd">
            <div id="inputPanel" class="hidden">
              <div class="row controls">
              <div class="rightStrip">
                <label for="inputDate" data-i18n="labels.date">Date</label>
                <input type="date" id="inputDate" />
              </div>

              <div class="rightStrip">
                <label for="timeSlot" data-i18n="labels.time">Time</label>
                <select id="timeSlot">
                  <option value="auto" data-i18n="time.auto">Auto</option>
                  <option value="morning" data-i18n="time.morning">Morning</option>
                  <option value="evening" data-i18n="time.evening">Evening</option>
                  <option value="custom" data-i18n="time.custom">Custom</option>
                </select>
                <select id="timeCustom" class="hidden">
                  <option value="midday" data-i18n="time.midday">Midday</option>
                  <option value="night" data-i18n="time.night">Night</option>
                  <option value="other" data-i18n="time.other">Other</option>
                </select>
              </div>

              <div class="toggle" title="This is stored per day" data-i18n-title="medication.titleHint">
                <div class="switch" id="medSwitch" role="switch" aria-checked="false" tabindex="0"></div>
                <div>
                  <div style="font-weight:800" data-i18n="medication.title">Medication taken today</div>
                  <div class="notice" data-i18n="medication.note">Stored per date. It will show in the review list.</div>
                </div>
              </div>
            </div>
              <div class="sep"></div>

              <div class="row">
                <div class="field" style="flex:1">
                  <div class="top">
                    <div>
                      <div style="font-weight:800" data-i18n="reading.one.title">Reading #1</div>
                      <div class="hint" data-i18n="reading.hint">Enter systolic / diastolic / heart rate</div>
                    </div>
                    <div class="badge mono" id="cat1">â€”</div>
                  </div>

                  <div class="triple">
                    <div>
                      <label data-i18n="labels.systolic">Systolic (SP)</label>
                      <div class="valbox">
                        <div class="numControl">
                          <button class="adjustBtn" type="button" data-adjust-target="sp1n" data-adjust-dir="-1" aria-label="Decrease systolic">âˆ’</button>
                          <input class="mono" type="number" id="sp1n" min="60" max="200" step="1" />
                          <button class="adjustBtn" type="button" data-adjust-target="sp1n" data-adjust-dir="1" aria-label="Increase systolic">+</button>
                        </div>
                        <span class="mono" style="color:var(--muted); font-weight:700" data-i18n="units.mmhg">mmHg</span>
                      </div>
                      <input class="vitalsSlider hidden" type="range" id="sp1r" min="60" max="200" step="1" />
                    </div>

                    <div>
                      <label data-i18n="labels.diastolic">Diastolic (DP)</label>
                      <div class="valbox">
                        <div class="numControl">
                          <button class="adjustBtn" type="button" data-adjust-target="dp1n" data-adjust-dir="-1" aria-label="Decrease diastolic">âˆ’</button>
                          <input class="mono" type="number" id="dp1n" min="40" max="160" step="1" />
                          <button class="adjustBtn" type="button" data-adjust-target="dp1n" data-adjust-dir="1" aria-label="Increase diastolic">+</button>
                        </div>
                        <span class="mono" style="color:var(--muted); font-weight:700" data-i18n="units.mmhg">mmHg</span>
                      </div>
                      <input class="vitalsSlider hidden" type="range" id="dp1r" min="40" max="160" step="1" />
                    </div>

                    <div>
                      <label data-i18n="labels.heartRate">Heart rate</label>
                      <div class="valbox">
                        <div class="numControl">
                          <button class="adjustBtn" type="button" data-adjust-target="hr1n" data-adjust-dir="-1" aria-label="Decrease heart rate">âˆ’</button>
                          <input class="mono" type="number" id="hr1n" min="60" max="130" step="1" />
                          <button class="adjustBtn" type="button" data-adjust-target="hr1n" data-adjust-dir="1" aria-label="Increase heart rate">+</button>
                        </div>
                        <span class="mono" style="color:var(--muted); font-weight:700" data-i18n="units.bpm">bpm</span>
                      </div>
                      <input class="vitalsSlider hidden" type="range" id="hr1r" min="60" max="130" step="1" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="timer" style="flex:1">
                  <div>
                    <div style="font-weight:800" data-i18n="timer.title">1-minute rest timer</div>
                    <div class="mini" data-i18n="timer.subtitle">Use between Reading #1 and Reading #2</div>
                  </div>
                  <div style="display:flex; gap:10px; align-items:center;">
                    <div class="mono"><strong id="timer">01:00</strong></div>
                    <button class="btn secondary" id="btnTimer" data-i18n="actions.start">Start</button>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="field" style="flex:1">
                  <div class="top">
                    <div>
                      <div style="font-weight:800" data-i18n="reading.two.title">Reading #2</div>
                      <div class="hint" data-i18n="reading.two.hint">Timer optional, but recommended</div>
                    </div>
                    <div class="badge mono" id="cat2">â€”</div>
                  </div>

                  <div class="triple">
                    <div>
                      <label data-i18n="labels.systolic">Systolic (SP)</label>
                      <div class="valbox">
                        <div class="numControl">
                          <button class="adjustBtn" type="button" data-adjust-target="sp2n" data-adjust-dir="-1" aria-label="Decrease systolic">âˆ’</button>
                          <input class="mono" type="number" id="sp2n" min="60" max="200" step="1" />
                          <button class="adjustBtn" type="button" data-adjust-target="sp2n" data-adjust-dir="1" aria-label="Increase systolic">+</button>
                        </div>
                        <span class="mono" style="color:var(--muted); font-weight:700" data-i18n="units.mmhg">mmHg</span>
                      </div>
                      <input class="vitalsSlider hidden" type="range" id="sp2r" min="60" max="200" step="1" />
                    </div>

                    <div>
                      <label data-i18n="labels.diastolic">Diastolic (DP)</label>
                      <div class="valbox">
                        <div class="numControl">
                          <button class="adjustBtn" type="button" data-adjust-target="dp2n" data-adjust-dir="-1" aria-label="Decrease diastolic">âˆ’</button>
                          <input class="mono" type="number" id="dp2n" min="40" max="160" step="1" />
                          <button class="adjustBtn" type="button" data-adjust-target="dp2n" data-adjust-dir="1" aria-label="Increase diastolic">+</button>
                        </div>
                        <span class="mono" style="color:var(--muted); font-weight:700" data-i18n="units.mmhg">mmHg</span>
                      </div>
                      <input class="vitalsSlider hidden" type="range" id="dp2r" min="40" max="160" step="1" />
                    </div>

                    <div>
                      <label data-i18n="labels.heartRate">Heart rate</label>
                      <div class="valbox">
                        <div class="numControl">
                          <button class="adjustBtn" type="button" data-adjust-target="hr2n" data-adjust-dir="-1" aria-label="Decrease heart rate">âˆ’</button>
                          <input class="mono" type="number" id="hr2n" min="60" max="130" step="1" />
                          <button class="adjustBtn" type="button" data-adjust-target="hr2n" data-adjust-dir="1" aria-label="Increase heart rate">+</button>
                        </div>
                        <span class="mono" style="color:var(--muted); font-weight:700" data-i18n="units.bpm">bpm</span>
                      </div>
                      <input class="vitalsSlider hidden" type="range" id="hr2r" min="60" max="130" step="1" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="row" style="justify-content:space-between">
                <div class="notice" style="max-width:520px" data-i18n="notices.saveAverage">
                  Saved value = average of two readings (SP/DP/HR). Category uses the higher-risk of SP vs DP.
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap">
                  <button class="btn secondary" id="btnQuickFill" data-i18n="actions.resetDefaults">Reset to defaults</button>
                  <button class="btn" id="btnSave" data-i18n="actions.saveAveraged">Save averaged record</button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="stack">
          <div class="card">
            <div class="hd">
              <div>
                <h2 data-i18n="recent.title">Recent records</h2>
                <div class="hint" data-i18n="recent.hint">Latest 10 averaged entries</div>
              </div>
              <div class="badge mono" id="countBadge"></div>
            </div>
            <div class="bd">
              <div class="list" id="recentList"></div>
              <div class="sep"></div>
            </div>
          </div>

          <div class="card" id="dataCard">
            <div class="hd">
              <div>
                <h2 data-i18n="data.title">Data Management</h2>
                <div class="hint" data-i18n="data.hint">Backup, import, and local storage tools</div>
              </div>
              <button class="btn secondary smallBtn" id="btnDataToggle" aria-expanded="true" data-i18n="data.collapse">Collapse</button>
            </div>
            <div class="bd" id="dataBody">
              <div class="row" style="justify-content:space-between">
                <div class="notice" data-i18n-html="notices.localStorage">
                  Data is stored locally in your browser via <code>localStorage</code>.
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap">
                  <button class="btn secondary smallBtn" id="btnExport" data-i18n="actions.export">Export JSON</button>
                  <button class="btn secondary smallBtn" id="btnImport" data-i18n="actions.import">Import JSON</button>
                  <button class="btn danger smallBtn" id="btnWipe" data-i18n="actions.wipe">Wipe all data</button>
                </div>
              </div>

              <div class="sep"></div>

              <div class="row driveRow">
                <div class="notice" data-i18n-html="drive.backupNotice">
                  Save a backup in your Google Drive <strong>AppData</strong> folder (hidden from normal view).
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
                  <span class="driveStatus" id="driveStatus" data-i18n="drive.signedOut">Drive: signed out</span>
                  <button class="btn google smallBtn" id="btnDriveSignIn" data-i18n="drive.signIn">Sign in to Google Drive</button>
                  <button class="btn secondary smallBtn hidden" id="btnDriveSignOut" data-i18n="drive.signOut">Sign out</button>
                  <button class="btn secondary smallBtn" id="btnDriveSave" disabled data-i18n="drive.save">Save to Drive</button>
                  <label class="notice" id="driveStayWrap" style="display:flex; align-items:center; gap:6px">
                    <input type="checkbox" id="driveStaySignedIn" />
                    <span data-i18n="drive.staySignedIn">Stay signed in</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- REVIEW VIEW -->
    <section id="viewReview" class="hidden">
      <div class="grid">

        <div class="card">
          <div class="hd">
            <div>
              <h2 data-i18n="review.title">Review</h2>
              <div class="hint" data-i18n="review.hint">1 day (dual-axis) â€¢ 7 days â€¢ 4 weeks</div>
            </div>
            <div class="badge mono" id="reviewRangeBadge"></div>
          </div>
          <div class="bd">

            <div class="row controls">
              <label for="reviewMode" data-i18n="review.modeLabel">Mode</label>
              <select id="reviewMode">
                <option value="1d" data-i18n="review.mode1d">1 day</option>
                <option value="7d" data-i18n="review.mode7d">7 days</option>
                <option value="4w" data-i18n="review.mode4w">4 weeks</option>
              </select>

              <label for="reviewEndDate" data-i18n="review.endDateLabel">End date</label>
              <input type="date" id="reviewEndDate" />

              <button class="btn secondary" id="btnRefresh" data-i18n="actions.refresh">Refresh</button>
            </div>

            <div class="sep"></div>

            <div class="chartWrap">
              <canvas id="chart" width="900" height="360"></canvas>
              <div class="legend" id="legend"></div>
            </div>

            <div class="footerRow">
              <div class="notice" id="reviewNote"></div>
              <div class="pill mono" id="statsPill"></div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2 data-i18n="range.title">Records in range</h2>
              <div class="hint" data-i18n="range.hint">Grouped by date; medication flag shown per day</div>
            </div>
          </div>
          <div class="bd">
            <div class="rangeTableWrap" id="rangeList"></div>
          </div>
        </div>

      </div>
    </section>

  </div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, '0');
  const fmtDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseDate = (s) => {
    const [y,m,dd] = s.split('-').map(Number);
    return new Date(y, m-1, dd);
  };
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

  const i18n = {
    en: {
      'app.title': 'BP Tracker',
      'app.subtitle': 'Two readings âœ auto-average âœ review by day / 7 days / 4 weeks',
      'tabs.input': 'Input',
      'tabs.review': 'Review',
      'labels.date': 'Date',
      'labels.time': 'Time',
      'labels.systolic': 'Systolic (SP)',
      'labels.diastolic': 'Diastolic (DP)',
      'labels.heartRate': 'Heart rate',
      'labels.hrShort': 'HR',
      'units.mmhg': 'mmHg',
      'units.bpm': 'bpm',
      'time.auto': 'Auto',
      'time.morning': 'Morning',
      'time.evening': 'Evening',
      'time.custom': 'Custom',
      'time.midday': 'Midday',
      'time.night': 'Night',
      'time.other': 'Other',
      'input.title': 'Measurement input',
      'input.hint': 'Defaults to last 7-day averages (or 120/80 HR 80)',
      'prep.title': 'Before your measurement',
      'prep.step1': 'Sit comfortably in a chair with back supported (not perched on the edge).',
      'prep.step2': 'Feet flat on the floor, legs uncrossed.',
      'prep.step3': 'Rest your arm on a table/armrest so the cuff is at heart level.',
      'prep.step4': 'Relax your shoulders, jaw, and hands (donâ€™t clench a fist).',
      'prep.step5': 'Stay still and quietâ€”no talking, no phone scrolling, no reading something stressful, no walking around.',
      'medication.title': 'Medication taken today',
      'medication.note': 'Stored per date. It will show in the review list.',
      'medication.titleHint': 'This is stored per day',
      'reading.one.title': 'Reading #1',
      'reading.two.title': 'Reading #2',
      'reading.hint': 'Enter systolic / diastolic / heart rate',
      'reading.two.hint': 'Timer optional, but recommended',
      'timer.title': '1-minute rest timer',
      'timer.subtitle': 'Use between Reading #1 and Reading #2',
      'notices.saveAverage': 'Saved value = average of two readings (SP/DP/HR). Category uses the higher-risk of SP vs DP.',
      'notices.localStorage': 'Data is stored locally in your browser via <code>localStorage</code>.',
      'actions.start': 'Start',
      'actions.stop': 'Stop',
      'actions.resetDefaults': 'Reset to defaults',
      'actions.saveAveraged': 'Save averaged record',
      'actions.scale': 'UI setting',
      'actions.close': 'Close',
      'scale.title': 'UI setting',
      'scale.text': 'Text size',
      'scale.buttons': 'Button size',
      'scale.showInputSliders': 'Show SP/DP/HR sliders in input',
      'actions.export': 'Export JSON',
      'actions.import': 'Import JSON',
      'actions.wipe': 'Wipe all data',
      'actions.refresh': 'Refresh',
      'actions.edit': 'Edit',
      'actions.delete': 'Delete',
      'actions.cancel': 'Cancel',
      'actions.confirmChange': 'Confirm change',
      'edit.title': 'Edit measurement',
      'actions.addMeasurement': 'Add measurement',
      'defaults.prefix': 'Defaults: {source}',
      'defaults.sevenDay': '7-day avg (n={count})',
      'defaults.fallback': 'Default 120/80 HR 80',
      'drive.backupNotice': 'Save a backup in your Google Drive <strong>AppData</strong> folder (hidden from normal view).',
      'drive.signedOut': 'Drive: signed out',
      'drive.reconnecting': 'Drive: reconnecting...',
      'drive.connected': 'Drive: connected',
      'drive.saving': 'Drive: saving...',
      'drive.saved': 'Drive: saved to AppData',
      'drive.signIn': 'Sign in to Google Drive',
      'drive.signOut': 'Sign out',
      'drive.save': 'Save to Drive',
      'drive.staySignedIn': 'Stay signed in',
      'data.title': 'Data Management',
      'data.hint': 'Backup, import, and local storage tools',
      'data.collapse': 'Collapse',
      'data.expand': 'Expand',
      'recent.title': 'Recent records',
      'recent.hint': 'Latest 10 averaged entries',
      'recent.count': '{count} total',
      'recent.empty': 'No records yet. Add your first entry in <b>Input</b>.',
      'recent.tip': 'Tip: Take two readings 1 minute apart. Save will store the average.',
      'review.title': 'Review',
      'review.hint': '1 day (dual-axis) â€¢ 7 days â€¢ 4 weeks',
      'review.modeLabel': 'Mode',
      'review.endDateLabel': 'End date',
      'review.mode1d': '1 day',
      'review.mode7d': '7 days',
      'review.mode4w': '4 weeks',
      'review.rangeBadge': '{range} ending {date}',
      'review.noData': 'No data in range',
      'review.addEntries': 'Add entries in Input, then come back here.',
      'review.avgStats': 'Avg: {sp}/{dp} â€¢ {cat} ({count} records)',
      'review.note': 'Morning uses triangle, evening uses square. SP uses left axis and DP uses right axis.',
      'range.title': 'Records in range',
      'range.hint': 'Morning and evening values are shown in table format',
      'range.noEntries': 'no entries',
      'range.noRecords': 'No records in this range.',
      'range.emptyDay': 'â€”',
      'range.table.date': 'Date',
      'range.table.morning': 'Morning (SP/DP)',
      'range.table.morningHr': 'Morning HR',
      'range.table.evening': 'Evening (SP/DP)',
      'range.table.eveningHr': 'Evening HR',
      'range.table.medication': 'Medication',
      'chart.noRecordsDay': 'No records for this day.',
      'chart.noRecordsRange': 'No records in this range.',
      'chart.titleOneDay': 'Systolic (left) / Diastolic (right) â€” {date}',
      'chart.titleMulti': 'BP over time (SP & DP) â€” {range}',
      'legend.spLine': 'Systolic (SP) line',
      'legend.dpLine': 'Diastolic (DP) line',
      'legend.bands': 'Bands: Normal / Stage 1 / Stage 2 / Stage 3',
      'legend.dpStrip': 'Right strip: DP bands',
      'legend.sp': 'SP (systolic)',
      'legend.dp': 'DP (diastolic)',
      'legend.points': 'Markers: morning â–² / evening â–  (SP and DP)',
      'legend.bars': 'Single shared y-axis range',
      'legend.meds': 'ğŸ’Š medication taken (per day)',
      'cat.normal': 'Normal',
      'cat.stage1': 'Stage 1',
      'cat.stage2': 'Stage 2',
      'cat.stage3': 'Stage 3',
      'timeSlot.auto': 'Auto',
      'timeSlot.morning': 'Morning',
      'timeSlot.evening': 'Evening',
      'timeSlot.custom': 'Custom',
      'alerts.importFailed': 'Import failed: {message}',
      'alerts.wipeConfirm': 'Wipe all BP records and medication flags from this browser?',
      'alerts.signInFailed': 'Google sign-in failed: {message}',
      'alerts.driveSaveFailed': 'Drive save failed: {message}',
      'alerts.driveListFailed': 'Drive list failed.',
      'alerts.driveDownloadFailed': 'Drive download failed.',
      'alerts.driveUploadFailed': 'Drive upload failed.',
      'drive.restoreFailed': 'Drive restore failed: {message}',
      'drive.restoreEmpty': 'Drive restore failed: No backup found.',
      'today.label': 'Today: {date}'
    },
    zh: {
      'app.title': 'è¡€å£“è¿½è¹¤',
      'app.subtitle': 'å…©æ¬¡é‡æ¸¬ âœ è‡ªå‹•å¹³å‡ âœ ä¾æ—¥ï¼7 å¤©ï¼4 é€±æª¢è¦–',
      'tabs.input': 'è¼¸å…¥',
      'tabs.review': 'æª¢è¦–',
      'labels.date': 'æ—¥æœŸ',
      'labels.time': 'æ™‚é–“',
      'labels.systolic': 'æ”¶ç¸®å£“ (SP)',
      'labels.diastolic': 'èˆ’å¼µå£“ (DP)',
      'labels.heartRate': 'å¿ƒè·³',
      'labels.hrShort': 'å¿ƒè·³',
      'units.mmhg': 'mmHg',
      'units.bpm': 'bpm',
      'time.auto': 'è‡ªå‹•',
      'time.morning': 'æ—©ä¸Š',
      'time.evening': 'æ™šä¸Š',
      'time.custom': 'è‡ªè¨‚',
      'time.midday': 'ä¸­åˆ',
      'time.night': 'æ·±å¤œ',
      'time.other': 'å…¶ä»–',
      'input.title': 'é‡æ¸¬è¼¸å…¥',
      'input.hint': 'é è¨­ç‚ºè¿‘ 7 å¤©å¹³å‡ï¼ˆæˆ– 120/80 å¿ƒè·³ 80ï¼‰',
      'prep.title': 'é‡æ¸¬å‰æº–å‚™',
      'prep.step1': 'èˆ’æœåœ°ååœ¨æœ‰æ¤…èƒŒæ”¯æ’çš„æ¤…å­ä¸Šï¼ˆä¸è¦åªååœ¨æ¤…ç·£ï¼‰ã€‚',
      'prep.step2': 'é›™è…³å¹³æ”¾åœ°é¢ï¼Œé›™è…¿ä¸è¦äº¤å‰ã€‚',
      'prep.step3': 'æ‰‹è‡‚æ”¾åœ¨æ¡Œé¢æˆ–æ‰¶æ‰‹ä¸Šï¼Œè®“è¡€å£“è¢–å¸¶èˆ‡å¿ƒè‡ŸåŒé«˜ã€‚',
      'prep.step4': 'æ”¾é¬†è‚©è†€ã€ä¸‹å·´èˆ‡é›™æ‰‹ï¼ˆä¸è¦æ¡æ‹³ï¼‰ã€‚',
      'prep.step5': 'ä¿æŒå®‰éœèˆ‡ä¸å‹•ï¼šä¸è¦èªªè©±ã€ä¸è¦æ»‘æ‰‹æ©Ÿã€ä¸è¦çœ‹è®“äººç·Šå¼µçš„å…§å®¹ï¼Œä¹Ÿä¸è¦èµ°å‹•ã€‚',
      'medication.title': 'ä»Šæ—¥å·²æœè—¥',
      'medication.note': 'ä»¥æ—¥æœŸå„²å­˜ï¼Œæœƒåœ¨æª¢è¦–æ¸…å–®é¡¯ç¤ºã€‚',
      'medication.titleHint': 'æ­¤è¨­å®šä»¥æ—¥æœŸå„²å­˜',
      'reading.one.title': 'é‡æ¸¬ #1',
      'reading.two.title': 'é‡æ¸¬ #2',
      'reading.hint': 'è¼¸å…¥æ”¶ç¸®å£“ / èˆ’å¼µå£“ / å¿ƒè·³',
      'reading.two.hint': 'è¨ˆæ™‚å¯ç•¥ï¼Œä½†å»ºè­°ä½¿ç”¨',
      'timer.title': '1 åˆ†é˜ä¼‘æ¯è¨ˆæ™‚å™¨',
      'timer.subtitle': 'ç”¨æ–¼é‡æ¸¬ #1 èˆ‡ #2 ä¹‹é–“',
      'notices.saveAverage': 'å„²å­˜å€¼ = å…©æ¬¡é‡æ¸¬å¹³å‡ï¼ˆSP/DP/HRï¼‰ã€‚åˆ†é¡ä»¥ SP èˆ‡ DP ä¸­è¼ƒé«˜é¢¨éšªç‚ºæº–ã€‚',
      'notices.localStorage': 'è³‡æ–™æœƒé€é <code>localStorage</code> å„²å­˜åœ¨ç€è¦½å™¨æœ¬æ©Ÿã€‚',
      'actions.start': 'é–‹å§‹',
      'actions.stop': 'åœæ­¢',
      'actions.resetDefaults': 'é‡è¨­ç‚ºé è¨­å€¼',
      'actions.saveAveraged': 'å„²å­˜å¹³å‡ç´€éŒ„',
      'actions.scale': 'ä»‹é¢è¨­å®š',
      'actions.close': 'é—œé–‰',
      'scale.title': 'ä»‹é¢è¨­å®š',
      'scale.text': 'æ–‡å­—å¤§å°',
      'scale.buttons': 'æŒ‰éˆ•å¤§å°',
      'scale.showInputSliders': 'åœ¨è¼¸å…¥é é¡¯ç¤º SP/DP/HR æ»‘æ¡¿',
      'actions.export': 'åŒ¯å‡º JSON',
      'actions.import': 'åŒ¯å…¥ JSON',
      'actions.wipe': 'æ¸…é™¤æ‰€æœ‰è³‡æ–™',
      'actions.refresh': 'æ›´æ–°',
      'actions.edit': 'ç·¨è¼¯',
      'actions.delete': 'åˆªé™¤',
      'actions.cancel': 'å–æ¶ˆ',
      'actions.confirmChange': 'ç¢ºèªä¿®æ”¹',
      'edit.title': 'ç·¨è¼¯é‡æ¸¬',
      'actions.addMeasurement': 'æ–°å¢é‡æ¸¬',
      'defaults.prefix': 'é è¨­å€¼ï¼š{source}',
      'defaults.sevenDay': 'è¿‘ 7 å¤©å¹³å‡ï¼ˆn={count}ï¼‰',
      'defaults.fallback': 'é è¨­ 120/80 å¿ƒè·³ 80',
      'drive.backupNotice': 'å°‡å‚™ä»½å­˜åˆ° Google Drive çš„ <strong>AppData</strong> è³‡æ–™å¤¾ï¼ˆå¹³å¸¸ä¸é¡¯ç¤ºï¼‰ã€‚',
      'drive.signedOut': 'Driveï¼šå·²ç™»å‡º',
      'drive.reconnecting': 'Driveï¼šé‡æ–°é€£ç·šä¸­...',
      'drive.connected': 'Driveï¼šå·²é€£ç·š',
      'drive.saving': 'Driveï¼šå„²å­˜ä¸­...',
      'drive.saved': 'Driveï¼šå·²å­˜åˆ° AppData',
      'drive.signIn': 'ç™»å…¥ Google Drive',
      'drive.signOut': 'ç™»å‡º',
      'drive.save': 'å­˜åˆ° Drive',
      'drive.staySignedIn': 'ä¿æŒç™»å…¥',
      'data.title': 'è³‡æ–™ç®¡ç†',
      'data.hint': 'å‚™ä»½ã€åŒ¯å…¥èˆ‡æœ¬æ©Ÿå„²å­˜å·¥å…·',
      'data.collapse': 'æ”¶åˆ',
      'data.expand': 'å±•é–‹',
      'recent.title': 'æœ€è¿‘ç´€éŒ„',
      'recent.hint': 'æœ€æ–° 10 ç­†å¹³å‡è³‡æ–™',
      'recent.count': '{count} ç­†',
      'recent.empty': 'å°šç„¡è³‡æ–™ã€‚è«‹å…ˆåœ¨ <b>è¼¸å…¥</b> æ–°å¢ç¬¬ä¸€ç­†ã€‚',
      'recent.tip': 'æç¤ºï¼šå»ºè­°å…©æ¬¡é‡æ¸¬é–“éš” 1 åˆ†é˜ï¼Œå„²å­˜æ™‚æœƒå–å¹³å‡ã€‚',
      'review.title': 'æª¢è¦–',
      'review.hint': '1 å¤©ï¼ˆé›™è»¸ï¼‰â€¢ 7 å¤© â€¢ 4 é€±',
      'review.modeLabel': 'æ¨¡å¼',
      'review.endDateLabel': 'çµæŸæ—¥æœŸ',
      'review.mode1d': '1 å¤©',
      'review.mode7d': '7 å¤©',
      'review.mode4w': '4 é€±',
      'review.rangeBadge': '{range}ï¼ˆæˆªè‡³ {date}ï¼‰',
      'review.noData': 'å€é–“å…§ç„¡è³‡æ–™',
      'review.addEntries': 'å…ˆåˆ°ã€Œè¼¸å…¥ã€æ–°å¢è³‡æ–™ï¼Œå†å›ä¾†æŸ¥çœ‹ã€‚',
      'review.avgStats': 'å¹³å‡ï¼š{sp}/{dp} â€¢ {cat}ï¼ˆ{count} ç­†ï¼‰',
      'review.note': 'æ—©ä¸Šç”¨ä¸‰è§’å½¢ã€æ™šä¸Šç”¨æ–¹å½¢ã€‚SP ä½¿ç”¨å·¦è»¸ï¼ŒDP ä½¿ç”¨å³è»¸ã€‚',
      'range.title': 'å€é–“å…§ç´€éŒ„',
      'range.hint': 'ä»¥è¡¨æ ¼é¡¯ç¤ºæ—©æ™šé‡æ¸¬èˆ‡æœè—¥ç‹€æ…‹',
      'range.noEntries': 'ç„¡ç´€éŒ„',
      'range.noRecords': 'æ­¤å€é–“æ²’æœ‰ç´€éŒ„ã€‚',
      'range.emptyDay': 'â€”',
      'range.table.date': 'æ—¥æœŸ',
      'range.table.morning': 'æ—©ä¸Šï¼ˆSP/DPï¼‰',
      'range.table.morningHr': 'æ—©ä¸Šå¿ƒè·³',
      'range.table.evening': 'æ™šä¸Šï¼ˆSP/DPï¼‰',
      'range.table.eveningHr': 'æ™šä¸Šå¿ƒè·³',
      'range.table.medication': 'æœè—¥',
      'chart.noRecordsDay': 'é€™ä¸€å¤©æ²’æœ‰ç´€éŒ„ã€‚',
      'chart.noRecordsRange': 'æ­¤å€é–“æ²’æœ‰ç´€éŒ„ã€‚',
      'chart.titleOneDay': 'æ”¶ç¸®å£“ï¼ˆå·¦ï¼‰/ èˆ’å¼µå£“ï¼ˆå³ï¼‰â€” {date}',
      'chart.titleMulti': 'è¡€å£“è¶¨å‹¢ï¼ˆSP & DPï¼‰â€” {range}',
      'legend.spLine': 'æ”¶ç¸®å£“ï¼ˆSPï¼‰æŠ˜ç·š',
      'legend.dpLine': 'èˆ’å¼µå£“ï¼ˆDPï¼‰æŠ˜ç·š',
      'legend.bands': 'å€é–“ï¼šæ­£å¸¸ï¼ç¬¬ 1 æœŸï¼ç¬¬ 2 æœŸï¼ç¬¬ 3 æœŸ',
      'legend.dpStrip': 'å³å´è‰²å¸¶ï¼šDP å€é–“',
      'legend.sp': 'SPï¼ˆæ”¶ç¸®å£“ï¼‰',
      'legend.dp': 'DPï¼ˆèˆ’å¼µå£“ï¼‰',
      'legend.points': 'æ¨™è¨˜ï¼šæ—©ä¸Š â–²ï¼æ™šä¸Š â– ï¼ˆSP èˆ‡ DPï¼‰',
      'legend.bars': 'å…±ç”¨å–®ä¸€ y è»¸ç¯„åœ',
      'legend.meds': 'ğŸ’Š ç•¶æ—¥å·²æœè—¥',
      'cat.normal': 'æ­£å¸¸',
      'cat.stage1': 'ç¬¬ 1 æœŸ',
      'cat.stage2': 'ç¬¬ 2 æœŸ',
      'cat.stage3': 'ç¬¬ 3 æœŸ',
      'timeSlot.auto': 'è‡ªå‹•',
      'timeSlot.morning': 'æ—©ä¸Š',
      'timeSlot.evening': 'æ™šä¸Š',
      'timeSlot.custom': 'è‡ªè¨‚',
      'alerts.importFailed': 'åŒ¯å…¥å¤±æ•—ï¼š{message}',
      'alerts.wipeConfirm': 'ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰è¡€å£“ç´€éŒ„èˆ‡ç”¨è—¥ç‹€æ…‹å—ï¼Ÿ',
      'alerts.signInFailed': 'Google ç™»å…¥å¤±æ•—ï¼š{message}',
      'alerts.driveSaveFailed': 'Drive å„²å­˜å¤±æ•—ï¼š{message}',
      'alerts.driveListFailed': 'Drive åˆ—è¡¨å–å¾—å¤±æ•—ã€‚',
      'alerts.driveDownloadFailed': 'Drive ä¸‹è¼‰å¤±æ•—ã€‚',
      'alerts.driveUploadFailed': 'Drive ä¸Šå‚³å¤±æ•—ã€‚',
      'drive.restoreFailed': 'Drive é‚„åŸå¤±æ•—ï¼š{message}',
      'drive.restoreEmpty': 'Drive é‚„åŸå¤±æ•—ï¼šæ‰¾ä¸åˆ°å‚™ä»½ã€‚',
      'today.label': 'ä»Šæ—¥ï¼š{date}'
    }
  };

  let currentLang = 'en';
  const langButtons = Array.from(document.querySelectorAll('[data-lang]'));

  function t(key, vars = {}){
    const dict = i18n[currentLang] || i18n.en;
    const fallback = i18n.en[key] || key;
    const raw = dict[key] || fallback;
    return raw.replace(/\{(\w+)\}/g, (_, k) => (vars[k] ?? `{${k}}`));
  }

  function applyStaticText(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      el.textContent = t(el.dataset.i18n);
    });
    document.querySelectorAll('[data-i18n-html]').forEach(el => {
      el.innerHTML = t(el.dataset.i18nHtml);
    });
    document.querySelectorAll('[data-i18n-title]').forEach(el => {
      el.setAttribute('title', t(el.dataset.i18nTitle));
    });
    document.querySelectorAll('[data-i18n-aria]').forEach(el => {
      el.setAttribute('aria-label', t(el.dataset.i18nAria));
    });
  }

  const driveStatusState = {key: 'drive.signedOut', connected: false, vars: {}};

  function setLanguage(lang){
    currentLang = i18n[lang] ? lang : 'en';
    localStorage.setItem('bp_lang', currentLang);
    document.documentElement.lang = currentLang === 'zh' ? 'zh-Hant' : 'en';
    document.title = t('app.title');
    langButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.lang === currentLang));
    applyStaticText();
    if (driveStatusState.key){
      driveStatus.textContent = t(driveStatusState.key, driveStatusState.vars);
    }
    btnTimer.textContent = isTimerRunning ? t('actions.stop') : t('actions.start');
    todayPill.textContent = t('today.label', {date: fmtDate(new Date())});
    if (defaultMeta && defaultBadge){
      const source = defaultMeta.kind === 'sevenDay'
        ? t('defaults.sevenDay', {count: defaultMeta.count})
        : t('defaults.fallback');
      defaultBadge.textContent = t('defaults.prefix', {source});
    }
    renderRecent();
    refreshReview();
    updateDataToggleLabel();
  }

  // Categories (4 bands requested: normal, stage1, stage2, stage3)
  // We'll treat 120-129 systolic as "Normal" band for display simplicity.
  function bpCategory(sp, dp){
    const s = Number(sp), d = Number(dp);
    // Stage 3 (crisis)
    if (s >= 180 || d >= 120) return {key:'s3', label:'Stage 3', desc:'â‰¥180 or â‰¥120'};
    // Stage 2
    if (s >= 140 || d >= 90)  return {key:'s2', label:'Stage 2', desc:'140â€“179 or 90â€“119'};
    // Stage 1
    if ((s >= 130 && s <= 139) || (d >= 80 && d <= 89)) return {key:'s1', label:'Stage 1', desc:'130â€“139 or 80â€“89'};
    // Normal
    return {key:'n', label:'Normal', desc:'<130 and <80'};
  }

  function catColor(key){
    const styles = getComputedStyle(document.documentElement);
    if (key==='s1') return styles.getPropertyValue('--s1').trim();
    if (key==='s2') return styles.getPropertyValue('--s2').trim();
    if (key==='s3') return styles.getPropertyValue('--s3').trim();
    return styles.getPropertyValue('--good').trim();
  }

  function catText(key){
    if (key==='s1') return t('cat.stage1');
    if (key==='s2') return t('cat.stage2');
    if (key==='s3') return t('cat.stage3');
    return t('cat.normal');
  }

  function prettySlot(slot){
    if (slot==='morning') return t('timeSlot.morning');
    if (slot==='evening') return t('timeSlot.evening');
    if (slot==='midday') return t('time.midday');
    if (slot==='night') return t('time.night');
    if (slot==='other') return t('time.other');
    return t('timeSlot.auto');
  }

  // ---------- Storage ----------
  const KEY_REC = 'bp_records_v1';
  const KEY_MEDS = 'bp_meds_v1';
  const KEY_DATA_COLLAPSE = 'bp_data_collapsed';
  const KEY_UI_SCALE = 'bp_ui_scale_v1';
  const KEY_INPUT_SLIDER_VISIBLE = 'bp_input_slider_visible_v1';

  function loadRecords(){
    try { return JSON.parse(localStorage.getItem(KEY_REC) || '[]'); }
    catch { return []; }
  }
  function saveRecords(list){
    localStorage.setItem(KEY_REC, JSON.stringify(list));
  }
  function loadMeds(){
    try { return JSON.parse(localStorage.getItem(KEY_MEDS) || '{}'); }
    catch { return {}; }
  }
  function saveMeds(map){
    localStorage.setItem(KEY_MEDS, JSON.stringify(map));
  }

  // Global scale controls (easy to tweak extremes)
  const SCALE_LEVEL_COUNT = 6;
  const TEXT_SCALE_RANGE = {min: 0.88, max: 1.24};
  const BUTTON_SCALE_RANGE = {min: 0.88, max: 1.24};
  let uiScalePrefs = {textLevel: 3, buttonLevel: 3};

  function sanitizeScaleLevel(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return 3;
    return clamp(Math.round(n), 1, SCALE_LEVEL_COUNT);
  }

  function levelToScale(level, range){
    const safeLevel = sanitizeScaleLevel(level);
    const progress = (safeLevel - 1) / (SCALE_LEVEL_COUNT - 1);
    return range.min + ((range.max - range.min) * progress);
  }

  function parsePx(v){
    const n = Number.parseFloat(v);
    return Number.isFinite(n) ? n : 0;
  }

  function storeTextBaseIfNeeded(el, currentScale = 1){
    if (!el.dataset.baseFontSize){
      const scaled = parsePx(getComputedStyle(el).fontSize);
      const base = currentScale > 0 ? (scaled / currentScale) : scaled;
      el.dataset.baseFontSize = String(base);
    }
  }

  function getTextScaleValue(){
    return levelToScale(uiScalePrefs.textLevel, TEXT_SCALE_RANGE);
  }

  function getButtonScaleValue(){
    return levelToScale(uiScalePrefs.buttonLevel, BUTTON_SCALE_RANGE);
  }

  function applyTextScale(scale){
    const nodes = [document.body, ...document.body.querySelectorAll('*')];
    nodes.forEach((el) => {
      if (!(el instanceof Element)) return;
      storeTextBaseIfNeeded(el, scale);
    });
    nodes.forEach((el) => {
      if (!(el instanceof Element)) return;
      const base = Number(el.dataset.baseFontSize || 0);
      if (base > 0){
        el.style.fontSize = `${base * scale}px`;
      }
    });
  }

  function scaleButtonDimensions(scale){
    document.querySelectorAll('button').forEach((btn) => {
      const cs = getComputedStyle(btn);
      if (!btn.dataset.basePadTop) btn.dataset.basePadTop = String(parsePx(cs.paddingTop) / scale);
      if (!btn.dataset.basePadRight) btn.dataset.basePadRight = String(parsePx(cs.paddingRight) / scale);
      if (!btn.dataset.basePadBottom) btn.dataset.basePadBottom = String(parsePx(cs.paddingBottom) / scale);
      if (!btn.dataset.basePadLeft) btn.dataset.basePadLeft = String(parsePx(cs.paddingLeft) / scale);
      if (!btn.dataset.baseRadius) btn.dataset.baseRadius = String(parsePx(cs.borderRadius) / scale);
      if (!btn.dataset.baseWidth && cs.width !== 'auto') btn.dataset.baseWidth = String(parsePx(cs.width) / scale);
      if (!btn.dataset.baseHeight && cs.height !== 'auto') btn.dataset.baseHeight = String(parsePx(cs.height) / scale);

      btn.style.paddingTop = `${Number(btn.dataset.basePadTop || 0) * scale}px`;
      btn.style.paddingRight = `${Number(btn.dataset.basePadRight || 0) * scale}px`;
      btn.style.paddingBottom = `${Number(btn.dataset.basePadBottom || 0) * scale}px`;
      btn.style.paddingLeft = `${Number(btn.dataset.basePadLeft || 0) * scale}px`;
      btn.style.borderRadius = `${Number(btn.dataset.baseRadius || 0) * scale}px`;
      if (btn.dataset.baseWidth) btn.style.width = `${Number(btn.dataset.baseWidth) * scale}px`;
      if (btn.dataset.baseHeight) btn.style.height = `${Number(btn.dataset.baseHeight) * scale}px`;
    });
  }

  function loadUiScalePrefs(){
    try{
      const raw = JSON.parse(localStorage.getItem(KEY_UI_SCALE) || '{}');
      return {
        textLevel: sanitizeScaleLevel(raw.textLevel),
        buttonLevel: sanitizeScaleLevel(raw.buttonLevel),
      };
    }catch{
      return {textLevel: 3, buttonLevel: 3};
    }
  }

  function saveUiScalePrefsLocal(prefs){
    uiScalePrefs = {
      textLevel: sanitizeScaleLevel(prefs.textLevel),
      buttonLevel: sanitizeScaleLevel(prefs.buttonLevel),
    };
    localStorage.setItem(KEY_UI_SCALE, JSON.stringify(uiScalePrefs));
  }

  function applyUiScalePrefs(prefs){
    saveUiScalePrefsLocal(prefs);
    const textScale = getTextScaleValue();
    const buttonScale = getButtonScaleValue();
    document.documentElement.style.setProperty('--text-scale', String(textScale));
    document.documentElement.style.setProperty('--button-scale', String(buttonScale));
    applyTextScale(textScale);
    scaleButtonDimensions(buttonScale);

    const textSlider = $('scaleTextSlider');
    const btnSlider = $('scaleButtonSlider');
    const textLabel = $('scaleTextLevel');
    const btnLabel = $('scaleButtonLevel');
    if (textSlider) textSlider.value = String(uiScalePrefs.textLevel);
    if (btnSlider) btnSlider.value = String(uiScalePrefs.buttonLevel);
    if (textLabel) textLabel.textContent = `${uiScalePrefs.textLevel}/${SCALE_LEVEL_COUNT}`;
    if (btnLabel) btnLabel.textContent = `${uiScalePrefs.buttonLevel}/${SCALE_LEVEL_COUNT}`;
  }


  function observeScaleForNewNodes(){
    const obs = new MutationObserver((mutations) => {
      let hasAdded = false;
      for (const m of mutations){
        if (m.addedNodes && m.addedNodes.length){
          hasAdded = true;
          break;
        }
      }
      if (!hasAdded) return;
      const textScale = getTextScaleValue();
      const buttonScale = getButtonScaleValue();
      applyTextScale(textScale);
      scaleButtonDimensions(buttonScale);
    });
    obs.observe(document.body, {childList:true, subtree:true});
  }

  function sortRecordsDesc(list){
    return list.slice().sort((a,b) => (b.date+a.timeSlot+b.time) < (a.date+a.timeSlot+a.time) ? -1 : 1);
  }

  function getLastNDaysAvg(records, n){
    const end = new Date();
    end.setHours(23,59,59,999);
    const start = new Date(end);
    start.setDate(end.getDate() - (n-1));
    start.setHours(0,0,0,0);

    const inRange = records.filter(r => {
      const d = parseDate(r.date);
      return d >= start && d <= end;
    });

    if (!inRange.length) return null;
    const sum = inRange.reduce((acc,r) => {
      acc.sp += r.spAvg;
      acc.dp += r.dpAvg;
      acc.hr += r.hrAvg;
      acc.n += 1;
      return acc;
    }, {sp:0, dp:0, hr:0, n:0});

    return {
      sp: Math.round(sum.sp / sum.n),
      dp: Math.round(sum.dp / sum.n),
      hr: Math.round(sum.hr / sum.n),
      n: sum.n
    };
  }

  // ---------- UI: Tabs ----------
  const tabInput = $('tabInput');
  const tabReview = $('tabReview');
  const viewInput = $('viewInput');
  const viewReview = $('viewReview');

  function showTab(which){
    const input = which === 'input';
    tabInput.classList.toggle('active', input);
    tabReview.classList.toggle('active', !input);
    tabInput.setAttribute('aria-selected', input ? 'true' : 'false');
    tabReview.setAttribute('aria-selected', input ? 'false' : 'true');
    viewInput.classList.toggle('hidden', !input);
    viewReview.classList.toggle('hidden', input);

    if (!input){
      refreshReview();
    }
  }

  tabInput.addEventListener('click', () => showTab('input'));
  tabReview.addEventListener('click', () => showTab('review'));

  // ---------- UI: Date and time slot ----------
  const inputDate = $('inputDate');
  const reviewEndDate = $('reviewEndDate');
  const timeSlot = $('timeSlot');
  const timeCustom = $('timeCustom');

  function autoTimeSlotForNow(){
    const h = new Date().getHours();
    return (h < 12) ? 'morning' : 'evening';
  }

  timeSlot.addEventListener('change', () => {
    timeCustom.classList.toggle('hidden', timeSlot.value !== 'custom');
  });

  // ---------- UI: Medication toggle (per date) ----------
  const medSwitch = $('medSwitch');
  let meds = loadMeds();

  function setMedUI(on){
    medSwitch.classList.toggle('on', !!on);
    medSwitch.setAttribute('aria-checked', on ? 'true' : 'false');
  }

  function currentInputDate(){
    return inputDate.value || fmtDate(new Date());
  }

  function syncMedFromStore(){
    const d = currentInputDate();
    if (inputPanelVisible){
      ensureMedDefaultForDate(d);
      return;
    }
    setMedUI(!!meds[d]);
  }

  function toggleMed(){
    const d = currentInputDate();
    meds[d] = !meds[d];
    saveMeds(meds);
    setMedUI(!!meds[d]);
    // refresh lists
    renderRecent();
    refreshReview();
  }

  medSwitch.addEventListener('click', toggleMed);
  medSwitch.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleMed(); }
  });
  inputDate.addEventListener('change', syncMedFromStore);

  // ---------- UI: Range/number sync helpers ----------
  function linkRangeNumber(rangeEl, numEl, min, max, onChange){
    const syncTo = (v) => {
      const val = clamp(Number(v), min, max);
      rangeEl.value = String(val);
      numEl.value = String(val);
      onChange && onChange();
    };

    const syncNumToRange = () => {
      const raw = numEl.value.trim();
      if (!raw || Number.isNaN(Number(raw))) return;
      syncTo(raw);
    };

    rangeEl.addEventListener('input', () => syncTo(rangeEl.value));
    numEl.addEventListener('input', () => onChange && onChange());
    numEl.addEventListener('change', syncNumToRange);
    numEl.addEventListener('blur', syncNumToRange);
    numEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        syncNumToRange();
      }
    });

    return {set: syncTo, syncNumToRange};
  }

  // Inputs
  const sp1 = linkRangeNumber($('sp1r'), $('sp1n'), 60, 200, updateCats);
  const dp1 = linkRangeNumber($('dp1r'), $('dp1n'), 40, 160, updateCats);
  const hr1 = linkRangeNumber($('hr1r'), $('hr1n'), 60, 130, updateCats);
  const sp2 = linkRangeNumber($('sp2r'), $('sp2n'), 60, 200, updateCats);
  const dp2 = linkRangeNumber($('dp2r'), $('dp2n'), 40, 160, updateCats);
  const hr2 = linkRangeNumber($('hr2r'), $('hr2n'), 60, 130, updateCats);

  const cat1 = $('cat1');
  const cat2 = $('cat2');

  document.querySelectorAll('[data-adjust-target]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const numEl = $(btn.dataset.adjustTarget);
      if (!numEl) return;
      const step = Number(numEl.step || 1) || 1;
      const dir = Number(btn.dataset.adjustDir || 0);
      const min = Number(numEl.min);
      const max = Number(numEl.max);
      const current = Number(numEl.value);
      const base = Number.isFinite(current) ? current : min;
      const next = clamp(base + (dir * step), min, max);
      numEl.value = String(next);
      numEl.dispatchEvent(new Event('change', {bubbles: true}));
    });
  });

  function updateCats(){
    const c1 = bpCategory($('sp1n').value, $('dp1n').value);
    const c2 = bpCategory($('sp2n').value, $('dp2n').value);

    cat1.textContent = catText(c1.key);
    cat2.textContent = catText(c2.key);

    cat1.style.background = catColor(c1.key);
    cat2.style.background = catColor(c2.key);

    cat1.style.color = 'var(--text)';
    cat2.style.color = 'var(--text)';
  }

  // ---------- Timer ----------
  const timerEl = $('timer');
  const btnTimer = $('btnTimer');
  const prepModal = $('prepModal');
  const btnPrepClose = $('btnPrepClose');
  let pendingInputOpen = false;
  let timer = null;
  let remain = 60;
  let isTimerRunning = false;

  function renderTimer(){
    const mm = pad2(Math.floor(remain / 60));
    const ss = pad2(remain % 60);
    timerEl.textContent = `${mm}:${ss}`;
  }

  function stopTimer(){
    if (timer){
      clearInterval(timer);
      timer = null;
    }
    isTimerRunning = false;
    btnTimer.textContent = t('actions.start');
  }

  function startTimer(){
    if (timer){
      stopTimer();
      return;
    }
    remain = 60;
    renderTimer();
    isTimerRunning = true;
    btnTimer.textContent = t('actions.stop');
    timer = setInterval(() => {
      remain -= 1;
      renderTimer();
      if (remain <= 0){
        stopTimer();
        // gentle nudge
        btnTimer.textContent = t('actions.start');
        btnTimer.animate([{transform:'scale(1)'},{transform:'scale(1.04)'},{transform:'scale(1)'}],{duration:380});
      }
    }, 1000);
  }

  btnTimer.addEventListener('click', startTimer);

  // ---------- Defaults: last 7 day avg or fallback ----------
  const defaultBadge = $('defaultBadge');
  const todayPill = $('todayPill');
  const inputPanel = $('inputPanel');
  const btnAddMeasurement = $('btnAddMeasurement');
  const dataBody = $('dataBody');
  const btnDataToggle = $('btnDataToggle');
  let defaultMeta = {kind: 'fallback', count: 0};
  let inputPanelVisible = false;
  let dataCollapsed = false;

  function hasRecordForDate(dateStr){
    return loadRecords().some((rec) => rec.date === dateStr);
  }

  function ensureMedDefaultForDate(dateStr){
    if (!hasRecordForDate(dateStr)){
      meds[dateStr] = false;
      saveMeds(meds);
      setMedUI(false);
      return;
    }
    setMedUI(!!meds[dateStr]);
  }

  function setInputPanelVisible(visible){
    inputPanelVisible = visible;
    inputPanel.classList.toggle('hidden', !visible);
    btnAddMeasurement.classList.toggle('hidden', visible);
  }

  function showInputPanel(){
    const dateStr = currentInputDate();
    ensureMedDefaultForDate(dateStr);
    applyDefaults();
    setInputPanelVisible(true);
  }

  function updateDataToggleLabel(){
    if (!btnDataToggle) return;
    btnDataToggle.textContent = t(dataCollapsed ? 'data.expand' : 'data.collapse');
    btnDataToggle.setAttribute('aria-expanded', dataCollapsed ? 'false' : 'true');
  }

  function setDataCollapsed(collapsed){
    dataCollapsed = collapsed;
    if (dataBody){
      dataBody.classList.toggle('hidden', collapsed);
    }
    updateDataToggleLabel();
    localStorage.setItem(KEY_DATA_COLLAPSE, collapsed ? '1' : '0');
  }

  function applyDefaults(){
    const recs = loadRecords();
    const avg7 = getLastNDaysAvg(recs, 7);

    const def = avg7
      ? {sp:avg7.sp, dp:avg7.dp, hr:avg7.hr, src:t('defaults.sevenDay', {count: avg7.n})}
      : {sp:120, dp:80, hr:80, src:t('defaults.fallback')};

    defaultMeta = avg7 ? {kind: 'sevenDay', count: avg7.n} : {kind: 'fallback', count: 0};
    if (defaultBadge){
      defaultBadge.textContent = t('defaults.prefix', {source: def.src});
    }

    sp1.set(def.sp); dp1.set(def.dp); hr1.set(def.hr);
    sp2.set(def.sp); dp2.set(def.dp); hr2.set(def.hr);

    updateCats();
  }

  $('btnQuickFill').addEventListener('click', applyDefaults);

  // ---------- Save record (averaged from 2 readings) ----------
  const btnSave = $('btnSave');

  function currentSlot(){
    const chosen = timeSlot.value;
    if (chosen === 'auto') return autoTimeSlotForNow();
    if (chosen === 'custom') return timeCustom.value;
    return chosen;
  }


  function resolveAutoDateAndSlot(baseDateStr){
    const now = new Date();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const hhmm = `${pad2(hour)}:${pad2(minute)}`;

    if (hour < 4){
      const d = parseDate(baseDateStr);
      d.setDate(d.getDate() - 1);
      return {date: fmtDate(d), slot:'evening', time:'23:59'};
    }

    if (hour < 12){
      return {date: baseDateStr, slot:'morning', time:hhmm};
    }

    if (hour < 17){
      return {date: baseDateStr, slot:'midday', time:hhmm};
    }

    return {date: baseDateStr, slot:'evening', time:hhmm};
  }

  function nowHHMM(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function saveAveraged(){
    // Read values
    const a = {
      sp: Number($('sp1n').value),
      dp: Number($('dp1n').value),
      hr: Number($('hr1n').value),
    };
    const b = {
      sp: Number($('sp2n').value),
      dp: Number($('dp2n').value),
      hr: Number($('hr2n').value),
    };

    // Basic validation
    const ok = (v, lo, hi) => Number.isFinite(v) && v>=lo && v<=hi;
    const valid =
      ok(a.sp,60,200) && ok(a.dp,40,160) && ok(a.hr,60,130) &&
      ok(b.sp,60,200) && ok(b.dp,40,160) && ok(b.hr,60,130);
    if (!valid){
      alert('Please ensure all values are within the allowed ranges.');
      return;
    }

    const spAvg = Math.round((a.sp + b.sp) / 2);
    const dpAvg = Math.round((a.dp + b.dp) / 2);
    const hrAvg = Math.round((a.hr + b.hr) / 2);
    const cat = bpCategory(spAvg, dpAvg);

    const inputDateStr = currentInputDate();
    const chosen = timeSlot.value;
    const resolved = chosen === 'auto'
      ? resolveAutoDateAndSlot(inputDateStr)
      : {date: inputDateStr, slot: currentSlot()};

    const date = resolved.date;
    const slot = resolved.slot;
    const recordTime = resolved.time || nowHHMM();

    if (!(date in meds)) meds[date] = false;

    const rec = {
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + '_' + Math.random().toString(16).slice(2),
      date,
      time: recordTime,
      timeSlot: slot,
      // raw readings
      r1: a,
      r2: b,
      // averaged
      spAvg,
      dpAvg,
      hrAvg,
      category: cat.key,
      // store meds flag at time of save (also stored per-day in meds map)
      medsTaken: !!meds[date],
      createdAt: Date.now()
    };

    const list = loadRecords();
    list.push(rec);
    saveRecords(list);

    // Refresh
    applyDefaults();
    renderRecent();
    refreshReview();
    setInputPanelVisible(false);
    requestAnimationFrame(() => {
      requestAnimationFrame(() => highlightRecentRecord(rec.id));
    });

    // Tiny feedback
    btnSave.animate([{transform:'scale(1)'},{transform:'scale(1.03)'},{transform:'scale(1)'}],{duration:260});

    // Auto backup latest data when Drive is connected.
    saveToDrive({silent:true});
  }

  btnSave.addEventListener('click', saveAveraged);
  function openPrepModal(){
    pendingInputOpen = true;
    prepModal.classList.remove('hidden');
  }

  function closePrepModal(){
    prepModal.classList.add('hidden');
    if (pendingInputOpen){
      showInputPanel();
      pendingInputOpen = false;
    }
  }

  btnAddMeasurement.addEventListener('click', openPrepModal);
  btnPrepClose.addEventListener('click', closePrepModal);
  prepModal.addEventListener('click', (e) => {
    if (e.target === prepModal){
      closePrepModal();
    }
  });

  // ---------- Recent list ----------
  const recentList = $('recentList');
  const countBadge = $('countBadge');

  function medEmoji(date){
    return meds[date] ? 'ğŸ’Š' : '';
  }

  function renderRecent(){
    const list = sortRecordsDesc(loadRecords());
    countBadge.textContent = t('recent.count', {count: list.length});

    const top = list.slice(0, 10);
    recentList.innerHTML = '';

    if (!top.length){
      recentList.innerHTML = `<div class="notice">${t('recent.empty')}</div>`;
      return;
    }

    for (const r of top){
      const cat = bpCategory(r.spAvg, r.dpAvg);
      const left = document.createElement('div');
      left.className = 'item';
      left.dataset.recId = r.id;

      const a = document.createElement('div');
      a.className = 'a';
      a.innerHTML = `
        <div class="mono" style="font-weight:900">
          ${r.spAvg}/${r.dpAvg} <span style="color:var(--muted); font-weight:700">${t('units.mmhg')}</span>
          <span style="margin-left:8px; color:var(--muted)">${t('labels.hrShort')} ${r.hrAvg}</span>
        </div>
        <div class="notice mono">
          ${r.date} â€¢ ${prettySlot(r.timeSlot)} â€¢ ${r.time}
          <span style="margin-left:8px">${medEmoji(r.date)}</span>
        </div>
      `;

      const b = document.createElement('div');
      b.className = 'b mono';
      b.innerHTML = `
        <div class="badge" style="background:${catColor(cat.key)}; color:var(--text); font-weight:900">${catText(cat.key)}</div>
        <div style="margin-top:6px; display:flex; gap:8px; justify-content:flex-end;"><button class="btn secondary smallBtn" data-edit="${r.id}">${t('actions.edit')}</button><button class="btn secondary smallBtn" data-del="${r.id}">${t('actions.delete')}</button></div>
      `;

      left.appendChild(a);
      left.appendChild(b);
      recentList.appendChild(left);
    }


    recentList.querySelectorAll('button[data-edit]').forEach(btn => {
      btn.addEventListener('click', () => openEditModal(btn.getAttribute('data-edit')));
    });

    // Delete handler
    recentList.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-del');
        const list2 = loadRecords().filter(x => x.id !== id);
        saveRecords(list2);
        renderRecent();
        refreshReview();
        saveToDrive({silent:true});
      });
    });
  }

  function highlightRecentRecord(recordId){
    if (!recordId) return;
    const target = recentList.querySelector(`[data-rec-id="${recordId}"]`);
    if (!target) return;
    target.classList.remove('flash');
    void target.offsetWidth;
    target.scrollIntoView({behavior:'smooth', block:'center'});
    target.classList.add('flash');
    target.addEventListener('animationend', () => {
      target.classList.remove('flash');
    }, {once:true});
  }


  // ---------- Edit modal ----------
  const editModal = $('editModal');
  const editDate = $('editDate');
  const editTime = $('editTime');
  const editSlot = $('editSlot');
  const editMedTaken = $('editMedTaken');
  const editSp = $('editSp');
  const editDp = $('editDp');
  const editHr = $('editHr');
  const btnEditConfirm = $('btnEditConfirm');
  const btnEditCancel = $('btnEditCancel');
  const btnEditCancelTop = $('btnEditCancelTop');
  let editingRecordId = '';

  function closeEditModal(){
    editModal.classList.add('hidden');
    editingRecordId = '';
  }

  function openEditModal(recordId){
    const rec = loadRecords().find((x) => x.id === recordId);
    if (!rec) return;
    editingRecordId = recordId;

    editDate.value = rec.date || fmtDate(new Date());
    editTime.value = rec.time || '08:00';
    editSlot.value = rec.timeSlot || 'morning';
    editSp.value = String(rec.spAvg ?? '');
    editDp.value = String(rec.dpAvg ?? '');
    editHr.value = String(rec.hrAvg ?? '');
    editMedTaken.checked = !!meds[rec.date];

    editModal.classList.remove('hidden');
  }

  function confirmEdit(){
    if (!editingRecordId) return;
    const sp = Number(editSp.value);
    const dp = Number(editDp.value);
    const hr = Number(editHr.value);
    const date = editDate.value || fmtDate(new Date());
    const time = editTime.value || '00:00';
    const slot = editSlot.value || 'morning';

    const ok = (v, lo, hi) => Number.isFinite(v) && v >= lo && v <= hi;
    if (!(ok(sp,60,200) && ok(dp,40,160) && ok(hr,60,130))){
      alert('Please ensure all values are within the allowed ranges.');
      return;
    }

    const records = loadRecords();
    const idx = records.findIndex((x) => x.id === editingRecordId);
    if (idx < 0) return;

    const cat = bpCategory(sp, dp);
    records[idx] = {
      ...records[idx],
      date,
      time,
      timeSlot: slot,
      spAvg: sp,
      dpAvg: dp,
      hrAvg: hr,
      category: cat.key,
      medsTaken: !!editMedTaken.checked,
    };

    meds[date] = !!editMedTaken.checked;
    saveMeds(meds);
    saveRecords(records);
    closeEditModal();
    renderRecent();
    refreshReview();
    saveToDrive({silent:true});
  }

  btnEditConfirm.addEventListener('click', confirmEdit);
  btnEditCancel.addEventListener('click', closeEditModal);
  btnEditCancelTop.addEventListener('click', closeEditModal);
  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) closeEditModal();
  });

  // ---------- Export/Import/Wipe ----------
  $('btnExport').addEventListener('click', () => {
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      records: loadRecords(),
      meds: loadMeds(),
      uiScale: uiScalePrefs,
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bp-tracker-export-${fmtDate(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $('btnImport').addEventListener('click', async () => {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'application/json';
    inp.onchange = async () => {
      const file = inp.files?.[0];
      if (!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || typeof data !== 'object') throw new Error('Bad JSON');
        if (!Array.isArray(data.records) || typeof data.meds !== 'object') throw new Error('Wrong schema');
        saveRecords(data.records);
        saveMeds(data.meds);
        applyUiScalePrefs(data.uiScale || loadUiScalePrefs());
        meds = loadMeds();
        syncMedFromStore();
        applyDefaults();
        renderRecent();
        refreshReview();
      }catch(err){
        alert(t('alerts.importFailed', {message: err?.message || String(err)}));
      }
    };
    inp.click();
  });

  $('btnWipe').addEventListener('click', () => {
    const ok = confirm(t('alerts.wipeConfirm'));
    if (!ok) return;
    localStorage.removeItem(KEY_REC);
    localStorage.removeItem(KEY_MEDS);
    meds = loadMeds();
    syncMedFromStore();
    applyDefaults();
    renderRecent();
    refreshReview();
  });

  // ---------- Google Drive (AppData) ----------
  const GOOGLE_CLIENT_ID = '332987792434-u7r3hdl46asbqo0si3ngqu46kdbgf2at.apps.googleusercontent.com';
  const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.appdata';
  const DRIVE_FILENAME = 'bp-tracker-data.json';
  const DRIVE_STAY_SIGNED_IN_KEY = 'bp_drive_stay_signed_in';
  const driveStatus = $('driveStatus');
  const btnDriveSignIn = $('btnDriveSignIn');
  const btnDriveSignOut = $('btnDriveSignOut');
  const btnDriveSave = $('btnDriveSave');
  const driveStaySignedIn = $('driveStaySignedIn');
  const driveStayWrap = $('driveStayWrap');
  let tokenClient = null;
  let accessToken = '';
  let tokenExpiresAt = 0;

  function setDriveStatus(key, connected, vars = {}){
    driveStatusState.key = key;
    driveStatusState.connected = connected;
    driveStatusState.vars = vars;
    driveStatus.textContent = t(key, vars);
    btnDriveSave.disabled = !connected;
    btnDriveSignIn.classList.toggle('hidden', connected);
    driveStayWrap.classList.toggle('hidden', connected);
    btnDriveSignOut.classList.toggle('hidden', !connected);
  }

  function setStaySignedIn(enabled){
    driveStaySignedIn.checked = enabled;
    localStorage.setItem(DRIVE_STAY_SIGNED_IN_KEY, enabled ? '1' : '0');
  }

  function getStaySignedIn(){
    return localStorage.getItem(DRIVE_STAY_SIGNED_IN_KEY) === '1';
  }

  function initDriveAuth(){
    const waitForGsi = () => {
      if (window.google?.accounts?.oauth2){
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: DRIVE_SCOPE,
          callback: () => {},
        });
        setDriveStatus('drive.signedOut', false);
        driveStaySignedIn.checked = getStaySignedIn();
        if (driveStaySignedIn.checked){
          setDriveStatus('drive.reconnecting', false);
          requestDriveToken('')
            .then(() => restoreFromDrive({silentNoBackup:true, silentFailure:true}))
            .catch(() => {
              setDriveStatus('drive.signedOut', false);
            });
        }
      } else {
        setTimeout(waitForGsi, 300);
      }
    };
    waitForGsi();
  }

  function requestDriveToken(prompt){
    return new Promise((resolve, reject) => {
      if (!tokenClient){
        reject(new Error('Google auth not ready.'));
        return;
      }
      tokenClient.callback = (resp) => {
        if (resp?.error){
          reject(new Error(resp.error));
          return;
        }
        accessToken = resp.access_token;
        tokenExpiresAt = Date.now() + (resp.expires_in ? resp.expires_in * 1000 : 0);
        setDriveStatus('drive.connected', true);
        resolve(accessToken);
      };
      tokenClient.requestAccessToken({prompt});
    });
  }

  async function ensureDriveToken(){
    if (accessToken && (!tokenExpiresAt || Date.now() < tokenExpiresAt - 10000)){
      return accessToken;
    }
    const prompt = accessToken ? '' : 'consent';
    return requestDriveToken(prompt);
  }

  async function findDriveFileId(){
    const q = `name='${DRIVE_FILENAME}' and 'appDataFolder' in parents and trashed=false`;
    const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&spaces=appDataFolder&fields=files(id,name,modifiedTime)`;
    const res = await fetch(url, {
      headers: {Authorization: `Bearer ${accessToken}`}
    });
    if (!res.ok){
      throw new Error(t('alerts.driveListFailed'));
    }
    const data = await res.json();
    return data.files?.[0]?.id || '';
  }

  async function fetchDrivePayload(fileId){
    if (!fileId) return null;
    const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
    const res = await fetch(url, {
      headers: {Authorization: `Bearer ${accessToken}`}
    });
    if (!res.ok){
      throw new Error(t('alerts.driveDownloadFailed'));
    }
    return res.json();
  }

  function mergeDriveData(localPayload, remotePayload){
    const remote = remotePayload && typeof remotePayload === 'object' ? remotePayload : {};
    const mergedRecords = [];
    const seen = new Set();
    const addRecord = (r) => {
      if (!r || typeof r !== 'object') return;
      const key = r.id || `${r.date}-${r.time}-${r.timeSlot}-${r.spAvg}-${r.dpAvg}-${r.hrAvg}`;
      if (seen.has(key)) return;
      seen.add(key);
      mergedRecords.push(r);
    };
    (remote.records || []).forEach(addRecord);
    (localPayload.records || []).forEach(addRecord);

    const mergedMeds = {...(remote.meds || {})};
    for (const [date, value] of Object.entries(localPayload.meds || {})){
      if (value) mergedMeds[date] = true;
      else if (mergedMeds[date] === undefined) mergedMeds[date] = value;
    }

    const remoteScale = remote.uiScale && typeof remote.uiScale === 'object' ? remote.uiScale : null;
    const localScale = localPayload.uiScale && typeof localPayload.uiScale === 'object' ? localPayload.uiScale : null;

    return {
      version: 1,
      exportedAt: new Date().toISOString(),
      records: mergedRecords,
      meds: mergedMeds,
      uiScale: localScale || remoteScale || {textLevel: 3, buttonLevel: 3},
    };
  }

  function applyDrivePayloadToLocal(payload){
    if (!payload || typeof payload !== 'object'){
      throw new Error('Invalid backup payload.');
    }
    const records = Array.isArray(payload.records) ? payload.records : [];
    const medsMap = payload.meds && typeof payload.meds === 'object' ? payload.meds : {};
    saveRecords(records);
    saveMeds(medsMap);
    applyUiScalePrefs(payload.uiScale || loadUiScalePrefs());
    meds = loadMeds();
    syncMedFromStore();
    applyDefaults();
    renderRecent();
    refreshReview();
  }

  async function restoreFromDrive(opts = {}){
    const {silentNoBackup = true, silentFailure = false} = opts;
    try{
      await ensureDriveToken();
      const fileId = await findDriveFileId();
      if (!fileId){
        if (!silentNoBackup){
          alert(t('drive.restoreEmpty'));
        }
        return false;
      }

      const remotePayload = await fetchDrivePayload(fileId);
      const localPayload = buildLocalPayload();
      const mergedPayload = mergeDriveData(localPayload, remotePayload);
      if (remotePayload?.uiScale && typeof remotePayload.uiScale === 'object'){
        mergedPayload.uiScale = remotePayload.uiScale;
      }
      applyDrivePayloadToLocal(mergedPayload);
      return true;
    }catch(err){
      if (!silentFailure){
        alert(t('drive.restoreFailed', {message: err?.message || String(err)}));
      }
      return false;
    }
  }

  function buildLocalPayload(){
    return {
      version: 1,
      exportedAt: new Date().toISOString(),
      records: loadRecords(),
      meds: loadMeds(),
      uiScale: uiScalePrefs,
    };
  }

  async function saveToDrive(opts = {}){
    const {silent = false} = opts;
    if (!accessToken) return false;
    try{
      await ensureDriveToken();
      const localPayload = buildLocalPayload();
      if (!silent){
        setDriveStatus('drive.saving', true);
      }
      const fileId = await findDriveFileId();
      // Mirror local state to Drive so manual deletions do not reappear after restore.
      await uploadToDrive(localPayload, fileId);
      if (!silent){
        setDriveStatus('drive.saved', true);
      }
      return true;
    }catch(err){
      if (!silent){
        setDriveStatus('drive.signedOut', false);
        alert(t('alerts.driveSaveFailed', {message: err?.message || String(err)}));
      }
      return false;
    }
  }

  async function uploadToDrive(payload, fileId = ''){
    const metadata = fileId
      ? {
          name: DRIVE_FILENAME,
          mimeType: 'application/json',
        }
      : {
          name: DRIVE_FILENAME,
          parents: ['appDataFolder'],
          mimeType: 'application/json',
        };
    const boundary = '-------bpTrackerDriveBoundary';
    const body = [
      `--${boundary}`,
      'Content-Type: application/json; charset=UTF-8',
      '',
      JSON.stringify(metadata),
      `--${boundary}`,
      'Content-Type: application/json',
      '',
      JSON.stringify(payload),
      `--${boundary}--`,
      ''
    ].join('\r\n');

    const url = fileId
      ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
      : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
    const method = fileId ? 'PATCH' : 'POST';

    const res = await fetch(url, {
      method,
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': `multipart/related; boundary=${boundary}`,
      },
      body
    });
    if (!res.ok){
      throw new Error(t('alerts.driveUploadFailed'));
    }
    return res.json();
  }

  btnDriveSignIn.addEventListener('click', async () => {
    try{
      await requestDriveToken('consent');
      if (driveStaySignedIn.checked){
        setStaySignedIn(true);
      }
      await restoreFromDrive({silentNoBackup:true});
    }catch(err){
      alert(t('alerts.signInFailed', {message: err?.message || String(err)}));
    }
  });

  btnDriveSignOut.addEventListener('click', () => {
    accessToken = '';
    tokenExpiresAt = 0;
    setStaySignedIn(false);
    setDriveStatus('drive.signedOut', false);
  });

  driveStaySignedIn.addEventListener('change', () => {
    setStaySignedIn(driveStaySignedIn.checked);
    if (driveStaySignedIn.checked && !accessToken && tokenClient){
      setDriveStatus('drive.reconnecting', false);
      requestDriveToken('')
        .then(() => restoreFromDrive({silentNoBackup:true, silentFailure:true}))
        .catch(() => {
          setDriveStatus('drive.signedOut', false);
        });
    }
  });

  btnDriveSave.addEventListener('click', async () => {
    await saveToDrive({silent:false});
  });

  // ---------- Review ----------
  const reviewMode = $('reviewMode');
  const btnRefresh = $('btnRefresh');
  const rangeList = $('rangeList');
  const reviewRangeBadge = $('reviewRangeBadge');
  const reviewNote = $('reviewNote');
  const statsPill = $('statsPill');

  btnRefresh.addEventListener('click', refreshReview);
  reviewMode.addEventListener('change', refreshReview);
  reviewEndDate.addEventListener('change', refreshReview);

  // Chart drawing
  const canvas = $('chart');
  const ctx = canvas.getContext('2d');

  function resizeCanvasToCSS(){
    // keep crisp on HiDPI
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(320, Math.floor(rect.width * dpr));
    const h = Math.max(240, Math.floor(rect.height * dpr));
    if (canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
    }
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(1,1);
    return {w, h, dpr};
  }

  function drawRoundedRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function clear(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  function text(x,y,str, color='rgba(233,238,246,.85)', size=12, align='left'){
    ctx.fillStyle = color;
    ctx.font = `600 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.textAlign = align;
    ctx.textBaseline = 'middle';
    ctx.fillText(str, x, y);
  }

  function axisTicks(min, max, steps){
    const span = max-min;
    const raw = span / steps;
    // round to 5 or 10
    const step = raw <= 5 ? 5 : raw <= 10 ? 10 : raw <= 20 ? 20 : 25;
    const ticks = [];
    let v = Math.ceil(min/step)*step;
    while (v <= max){
      ticks.push(v);
      v += step;
    }
    return ticks;
  }

  function drawBands1D(plot, yMapLeft, yMapRight){
    // background bands: Normal, Stage1, Stage2, Stage3
    const bands = [
      {key:'n', label:'Normal', sp:[100,129], dp:[60,79]},
      {key:'s1', label:'Stage 1', sp:[130,139], dp:[80,89]},
      {key:'s2', label:'Stage 2', sp:[140,179], dp:[90,119]},
      {key:'s3', label:'Stage 3', sp:[180,200], dp:[120,160]},
    ];

    // Fill full-width bands based on systolic ranges (left axis)
    for (const b of bands){
      const y1 = yMapLeft(b.sp[1]);
      const y2 = yMapLeft(b.sp[0]);
      ctx.fillStyle = catColor(b.key);
      ctx.fillRect(plot.x, y1, plot.w, (y2 - y1));
    }

    // Draw a thin strip on the right for diastolic bands (so the dual-axis intent is visible)
    const stripW = Math.max(8, plot.w * 0.03);
    for (const b of bands){
      const y1 = yMapRight(b.dp[1]);
      const y2 = yMapRight(b.dp[0]);
      ctx.fillStyle = catColor(b.key);
      ctx.fillRect(plot.x + plot.w - stripW, y1, stripW, (y2 - y1));
    }

    // border around strip
    ctx.strokeStyle = 'rgba(255,255,255,.10)';
    ctx.lineWidth = 1;
    ctx.strokeRect(plot.x + plot.w - stripW, plot.y, stripW, plot.h);
  }

  function drawGrid(plot, yTicks, yMap){
    ctx.lineWidth = 1;
    ctx.strokeStyle = 'rgba(255,255,255,.08)';

    for (const t of yTicks){
      const y = yMap(t);
      ctx.beginPath();
      ctx.moveTo(plot.x, y);
      ctx.lineTo(plot.x + plot.w, y);
      ctx.stroke();
      text(plot.x - 8, y, String(t), 'rgba(168,179,199,.85)', 11, 'right');
    }

    ctx.strokeStyle = 'rgba(255,255,255,.14)';
    ctx.strokeRect(plot.x, plot.y, plot.w, plot.h);
  }

  function drawLine(points, xMap, yMap, stroke='rgba(138,180,255,.95)'){
    if (points.length < 1) return;
    ctx.lineWidth = 2;
    ctx.strokeStyle = stroke;
    ctx.beginPath();
    for (let i=0;i<points.length;i++){
      const p = points[i];
      const x = xMap(p.x);
      const y = yMap(p.y);
      if (i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // points
    for (const p of points){
      const x = xMap(p.x);
      const y = yMap(p.y);
      ctx.fillStyle = stroke;
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fill();
    }
  }

  function drawBarsOrPoints(series, plot, xCenters, yMap, color){
    // series: array of {kind:'point', v:number} OR {kind:'bar', min:number, max:number}
    for (let i=0;i<series.length;i++){
      const x = xCenters[i];
      const item = series[i];

      if (item.kind === 'point'){
        const y = yMap(item.v);
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI*2);
        ctx.fill();
      } else {
        const y1 = yMap(item.max);
        const y2 = yMap(item.min);
        const w = Math.max(6, plot.w / (series.length * 4));
        ctx.fillStyle = color;
        drawRoundedRect(x - w/2, y1, w, Math.max(2, y2-y1), 4);
        ctx.fill();
      }
    }
  }

  function groupByDate(records){
    const map = new Map();
    for (const r of records){
      if (!map.has(r.date)) map.set(r.date, []);
      map.get(r.date).push(r);
    }
    // ensure deterministic ordering by time
    for (const [k, arr] of map.entries()){
      arr.sort((a,b) => (a.time || '').localeCompare(b.time || ''));
    }
    return map;
  }

  function rangeDays(endDateStr, days){
    const end = parseDate(endDateStr);
    end.setHours(23,59,59,999);
    const start = new Date(end);
    start.setDate(end.getDate() - (days-1));
    start.setHours(0,0,0,0);
    return {start, end};
  }

  function listDays(start, end){
    const out = [];
    const d = new Date(start);
    d.setHours(0,0,0,0);
    while (d <= end){
      out.push(fmtDate(d));
      d.setDate(d.getDate()+1);
    }
    return out;
  }

  function refreshReview(){
    const mode = reviewMode.value;
    const endStr = reviewEndDate.value || fmtDate(new Date());

    let days = 1;
    if (mode === '7d') days = 7;
    if (mode === '4w') days = 28;

    const {start, end} = rangeDays(endStr, days);
    const dayKeys = listDays(start, end);

    const all = loadRecords();
    const inRange = all.filter(r => {
      const d = parseDate(r.date);
      return d >= start && d <= end;
    });

    const byDate = groupByDate(inRange);

    // badge + note
    const title = mode==='1d' ? t('review.mode1d') : mode==='7d' ? t('review.mode7d') : t('review.mode4w');
    reviewRangeBadge.textContent = t('review.rangeBadge', {range: title, date: endStr});

    // list
    renderRangeList(dayKeys, byDate);

    // chart
    if (mode === '1d'){
      drawOneDay(endStr, byDate.get(endStr) || []);
    } else {
      drawMultiDay(dayKeys, byDate, mode);
    }

    // stats
    const n = inRange.length;
    if (!n){
      statsPill.textContent = t('review.noData');
      reviewNote.textContent = t('review.addEntries');
      return;
    }

    const spAvg = Math.round(inRange.reduce((s,r)=>s+r.spAvg,0)/n);
    const dpAvg = Math.round(inRange.reduce((s,r)=>s+r.dpAvg,0)/n);
    const cat = bpCategory(spAvg, dpAvg);
    statsPill.textContent = t('review.avgStats', {sp: spAvg, dp: dpAvg, cat: catText(cat.key), count: n});
    reviewNote.textContent = t('review.note');
  }

  function renderRangeList(dayKeys, byDate){
    rangeList.innerHTML = '';

    const reversed = dayKeys.slice().reverse();
    const table = document.createElement('table');
    table.className = 'rangeTable mono';
    table.innerHTML = `
      <thead>
        <tr>
          <th>${t('range.table.date')}</th>
          <th>${t('range.table.morning')}</th>
          <th>${t('range.table.morningHr')}</th>
          <th>${t('range.table.evening')}</th>
          <th>${t('range.table.eveningHr')}</th>
          <th>${t('range.table.medication')}</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    const tbody = table.querySelector('tbody');
    let any = false;

    const formatBpRows = (rows, withSlot=false) => {
      if (!rows.length) return t('range.emptyDay');
      return rows.map((r) => withSlot
        ? `${prettySlot(r.timeSlot)} ${r.spAvg}/${r.dpAvg}`
        : `${r.spAvg}/${r.dpAvg}`
      ).join('<br>');
    };
    const formatHrRows = (rows, withSlot=false) => {
      if (!rows.length) return t('range.emptyDay');
      return rows.map((r) => withSlot
        ? `${prettySlot(r.timeSlot)} ${r.hrAvg}`
        : `${r.hrAvg}`
      ).join('<br>');
    };

    for (const d of reversed){
      const arr = (byDate.get(d) || []).slice().sort((a,b) => (a.time || '').localeCompare(b.time || ''));
      if (arr.length) any = true;

      const morningRows = arr.filter(r => r.timeSlot === 'morning');
      const nonMorningRows = arr.filter(r => r.timeSlot !== 'morning');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d}</td>
        <td>${formatBpRows(morningRows)}</td>
        <td>${formatHrRows(morningRows)}</td>
        <td>${formatBpRows(nonMorningRows, true)}</td>
        <td>${formatHrRows(nonMorningRows, true)}</td>
        <td class="center">${meds[d] ? 'ğŸ’Š' : 'â€”'}</td>
      `;
      tbody.appendChild(tr);
    }

    if (!any){
      rangeList.innerHTML = `<div class="notice">${t('range.noRecords')}</div>`;
      return;
    }

    rangeList.appendChild(table);
  }

  function drawOneDay(dateStr, records){
    const {w, h} = resizeCanvasToCSS();
    clear();

    const padL = 48, padR = 48, padT = 18, padB = 42;
    const plot = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

    const spVals = records.map(r => r.spAvg);
    const dpVals = records.map(r => r.dpAvg);
    const yMin = dpVals.length ? Math.max(30, Math.min(...dpVals) - 20) : 60;
    const yMax = spVals.length ? Math.min(260, Math.max(...spVals) + 20) : 200;

    const yMap = (v) => plot.y + plot.h * (1 - (v - yMin) / (yMax - yMin));

    const yTicks = axisTicks(yMin, yMax, 6);
    drawGrid(plot, yTicks, yMap);

    // x positions based on order in day
    const sorted = records.slice().sort((a,b) => (a.time||'').localeCompare(b.time||''));

    const n = Math.max(1, sorted.length);
    const xMap = (i) => plot.x + (plot.w * (n===1 ? 0.5 : i/(n-1)));

    // series
    const spPts = sorted.map((r, i) => ({x:i, y:r.spAvg, meta:r}));
    const dpPts = sorted.map((r, i) => ({x:i, y:r.dpAvg, meta:r}));

    // lines
    drawLine(spPts.map(p=>({x:p.x,y:p.y})), xMap, yMap, 'rgba(138,180,255,.95)');
    drawLine(dpPts.map(p=>({x:p.x,y:p.y})), xMap, yMap, 'rgba(255,196,61,.95)');

    // x labels
    ctx.fillStyle = 'rgba(168,179,199,.9)';
    ctx.font = '600 11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    for (let i=0;i<sorted.length;i++){
      const r = sorted[i];
      const x = xMap(i);
      const label = `${prettySlot(r.timeSlot)}\n${r.time}`;
      // multi-line
      const parts = label.split('\n');
      ctx.fillText(parts[0], x, plot.y + plot.h + 10);
      ctx.fillText(parts[1], x, plot.y + plot.h + 24);
    }

    // Titles
    text(plot.x, plot.y - 8, t('chart.titleOneDay', {date: dateStr}), 'rgba(233,238,246,.92)', 12, 'left');

    // Legend
    setLegend([
      {label: t('legend.spLine'), color:'rgba(138,180,255,.95)'},
      {label: t('legend.dpLine'), color:'rgba(255,196,61,.95)'},
      {label: t('legend.bars'), color:'rgba(255,255,255,.25)'}
    ]);

    // If no records, show message
    if (!records.length){
      ctx.fillStyle = 'rgba(233,238,246,.85)';
      ctx.font = '700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(t('chart.noRecordsDay'), w/2, h/2);
    }
  }

  function drawMultiDay(dayKeys, byDate, mode){
    const {w, h} = resizeCanvasToCSS();
    clear();

    const padL = 52, padR = 52, padT = 18, padB = 48;
    const plot = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

    const allRecords = dayKeys.flatMap(day => byDate.get(day) || []);
    const spVals = allRecords.map(r => r.spAvg);
    const dpVals = allRecords.map(r => r.dpAvg);

    const yMin = dpVals.length ? Math.max(30, Math.min(...dpVals) - 20) : 60;
    const yMax = spVals.length ? Math.min(260, Math.max(...spVals) + 20) : 200;

    const yMap = (v) => plot.y + plot.h * (1 - (v - yMin) / (yMax - yMin));

    const yTicks = axisTicks(yMin, yMax, 6);
    drawGrid(plot, yTicks, yMap);

    const nDays = Math.max(1, dayKeys.length);
    const xCenters = dayKeys.map((_, i) => plot.x + plot.w * (nDays===1 ? 0.5 : i/(nDays-1)));
    const colorSP = 'rgba(138,180,255,.95)';
    const colorDP = 'rgba(255,196,61,.95)';

    const drawMarker = (x, y, type, color) => {
      ctx.fillStyle = color;
      ctx.beginPath();
      if (type === 'triangle'){
        ctx.moveTo(x, y - 5);
        ctx.lineTo(x - 5, y + 4);
        ctx.lineTo(x + 5, y + 4);
      } else if (type === 'square'){
        ctx.rect(x - 4, y - 4, 8, 8);
      } else {
        ctx.arc(x, y, 4, 0, Math.PI*2);
      }
      ctx.closePath();
      ctx.fill();
    };

    for (let i=0;i<dayKeys.length;i++){
      const day = dayKeys[i];
      const dayRecords = (byDate.get(day) || []).slice().sort((a,b) => (a.time || '').localeCompare(b.time || ''));
      const baseX = xCenters[i];
      let customOffset = -4;

      for (const r of dayRecords){
        let marker = 'circle';
        let offset = customOffset;
        if (r.timeSlot === 'morning'){
          marker = 'triangle';
          offset = -12;
        } else if (r.timeSlot === 'evening'){
          marker = 'square';
          offset = 12;
        } else {
          customOffset += 6;
        }

        const x = baseX + offset;
        drawMarker(x - 2, yMap(r.spAvg), marker, colorSP);
        drawMarker(x + 2, yMap(r.dpAvg), marker, colorDP);
      }
    }

    const step = mode==='4w' ? 4 : 1;
    ctx.fillStyle = 'rgba(168,179,199,.9)';
    ctx.font = '600 11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    for (let i=0;i<dayKeys.length;i+=step){
      const x = xCenters[i];
      const d = dayKeys[i];
      const dayRecords = byDate.get(d) || [];
      const aboveStage1Count = dayRecords.filter((r) => {
        const key = bpCategory(r.spAvg, r.dpAvg).key;
        return key === 's2' || key === 's3';
      }).length;

      ctx.fillText(d.slice(5), x, plot.y + plot.h + 10);
      if (meds[d]){
        ctx.fillText('ğŸ’Š', x, plot.y + plot.h + 24);
      }

      if (aboveStage1Count > 0){
        const cy = plot.y + plot.h + 40;
        ctx.fillStyle = 'rgba(255,120,80,.95)';
        ctx.beginPath();
        ctx.arc(x, cy, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'rgba(15,22,33,.95)';
        ctx.font = '700 10px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(String(aboveStage1Count), x, cy);
        ctx.textBaseline = 'top';
      }
    }

    const rangeTitle = mode==='7d' ? t('review.mode7d') : t('review.mode4w');
    text(plot.x, plot.y - 8, t('chart.titleMulti', {range: rangeTitle}), 'rgba(233,238,246,.92)', 12, 'left');

    setLegend([
      {label: t('legend.sp'), color: colorSP},
      {label: t('legend.dp'), color: colorDP},
      {label: t('legend.points'), color:'rgba(255,255,255,.25)'},
      {label: t('legend.bars'), color:'rgba(255,255,255,.25)'},
      {label: t('legend.meds'), color:'rgba(255,255,255,.25)'}
    ]);

    if (!allRecords.length){
      ctx.fillStyle = 'rgba(233,238,246,.85)';
      ctx.font = '700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(t('chart.noRecordsRange'), w/2, h/2);
    }
  }

  function setLegend(items){
    const el = $('legend');
    el.innerHTML = '';
    for (const it of items){
      const d = document.createElement('div');
      d.className = 'swatch';
      const sq = document.createElement('span');
      sq.className = 'sq';
      sq.style.background = it.color;
      sq.style.borderColor = 'rgba(255,255,255,.20)';
      const t = document.createElement('span');
      t.textContent = it.label;
      d.appendChild(sq);
      d.appendChild(t);
      el.appendChild(d);
    }
  }

  // ---------- UI scale modal ----------
  const btnScale = $('btnScale');
  const scaleModal = $('scaleModal');
  const btnScaleClose = $('btnScaleClose');
  const scaleTextSlider = $('scaleTextSlider');
  const scaleButtonSlider = $('scaleButtonSlider');
  const showInputSliders = $('showInputSliders');


  function applyInputSliderVisibility(show){
    document.querySelectorAll('.vitalsSlider').forEach((el) => {
      el.classList.toggle('hidden', !show);
    });
    showInputSliders.checked = !!show;
  }

  function loadInputSliderVisibility(){
    return localStorage.getItem(KEY_INPUT_SLIDER_VISIBLE) === '1';
  }

  function setInputSliderVisibility(show){
    localStorage.setItem(KEY_INPUT_SLIDER_VISIBLE, show ? '1' : '0');
    applyInputSliderVisibility(show);
  }

  function openScaleModal(){
    scaleModal.classList.remove('hidden');
  }

  function closeScaleModal(){
    scaleModal.classList.add('hidden');
  }

  btnScale.addEventListener('click', openScaleModal);
  btnScaleClose.addEventListener('click', closeScaleModal);
  scaleModal.addEventListener('click', (e) => {
    if (e.target === scaleModal){
      closeScaleModal();
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !prepModal.classList.contains('hidden')){
      closePrepModal();
      return;
    }
    if (e.key === 'Escape' && !scaleModal.classList.contains('hidden')){
      closeScaleModal();
    }
    if (e.key === 'Escape' && !editModal.classList.contains('hidden')){
      closeEditModal();
    }
  });

  function handleScaleChange(){
    applyUiScalePrefs({
      textLevel: scaleTextSlider.value,
      buttonLevel: scaleButtonSlider.value,
    });
    saveToDrive({silent:true});
  }

  scaleTextSlider.addEventListener('input', handleScaleChange);
  scaleButtonSlider.addEventListener('input', handleScaleChange);
  showInputSliders.addEventListener('change', () => setInputSliderVisibility(showInputSliders.checked));

  // ---------- Init ----------
  function init(){
    const today = fmtDate(new Date());
    inputDate.value = today;
    reviewEndDate.value = today;

    // default slot behavior
    timeSlot.value = 'auto';
    timeCustom.value = 'midday';
    timeCustom.classList.add('hidden');

    meds = loadMeds();
    syncMedFromStore();

    $('scaleTextSlider').max = String(SCALE_LEVEL_COUNT);
    $('scaleButtonSlider').max = String(SCALE_LEVEL_COUNT);
    applyUiScalePrefs(loadUiScalePrefs());
    observeScaleForNewNodes();
    initDriveAuth();
    applyInputSliderVisibility(loadInputSliderVisibility());

    const storedLang = localStorage.getItem('bp_lang');
    const browserLang = (navigator.language || '').toLowerCase();
    const initialLang = storedLang || (browserLang.startsWith('zh') ? 'zh' : 'en');
    setLanguage(initialLang);
    langButtons.forEach(btn => {
      btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
    });

    setInputPanelVisible(false);
    applyDefaults();
    dataCollapsed = localStorage.getItem(KEY_DATA_COLLAPSE) === '1';
    if (dataBody){
      dataBody.classList.toggle('hidden', dataCollapsed);
    }
    if (btnDataToggle){
      btnDataToggle.addEventListener('click', () => setDataCollapsed(!dataCollapsed));
    }
    updateDataToggleLabel();

    window.addEventListener('resize', () => {
      if (!viewReview.classList.contains('hidden')) refreshReview();
    });
  }

  init();

})();
</script>
</body>
</html>
